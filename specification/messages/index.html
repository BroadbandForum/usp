<!-- Reference Links -->
<h1 id="protocol-messages-overview">Protocol Messages Overview</h1>
<p><em>Note: This version of the specification defines its messages in <a href="https://developers.google.com/protocol-buffers/docs/proto3" title="Protocol Buffers v3 Protocol Buffers Mechanism for Serializing Structured Data Version 3">Protocol Buffers v3</a>. This part of the specification may change to a more generic description (normative and non-normative) if further encodings are specified in future versions.</em></p>
<p>These sections describes the types of USP messages and the normative requirements for their flow and operation. USP messages are described in a protocol buffers schema, and the normative requirements for the individual elements of the schema are outlined below:</p>
<ul>
<li><a href="add/">Add</a></li>
<li><a href="set/">Set</a></li>
<li><a href="delete/">Delete</a></li>
<li><a href="get/">Get</a></li>
<li><a href="getinstances/">GetInstances</a></li>
<li><a href="getsupoprteddm/">GetSupportedDM</a></li>
<li><a href="notify/">Notify</a></li>
<li><a href="operate/">Operate</a></li>
</ul>
<p>USP contains messages to create, read, update, and delete Objects, perform Object-defined operations, and allow agents to notify controllers of events. This is often referred to as CRUD with the addition of O (operate) and N (notify), or CRUD-ON.</p>
<h2 id="requests-responses-and-errors">Requests, Responses and Errors</h2>
<p><a id="requests_responses_and_errors" /></p>
<p>The three types of USP messages are Request, Response, and Error.</p>
<p>A request is a message sent from a source USP endpoint to a target USP endpoint that includes elements to be processed and returns a response or error. Unless otherwise specified, all requests have an associated response. Though the majority of requests are made from a Controller to an Agent, the Notify message follows the same format as a request but is sent from an Agent to a Controller.</p>
<p><strong>R-MSG.0</strong> – The target USP endpoint MUST respond to a request message from the source USP endpoint with either a response message or error message, unless otherwise specified (see Operate and Notify messages).</p>
<p><strong>R-MSG.1</strong> – The target USP endpoint MUST ignore or send an error message in response to messages it does not understand.</p>
<p><strong>R-MSG.2</strong> – When the target USP endpoint is not required to send a response, the MTP endpoint that received the message MUST gracefully end the MTP message exchange. How the MTP gracefully ends the MTP message exchange is dependent on the type of MTP.</p>
<h3 id="handling-duplicate-messages">Handling Duplicate Messages</h3>
<p><a id="handling_duplicate_messages" /></p>
<p>Circumstances may arise (such as multiple Message Transfer Protocols) that cause duplicate messages (those with an identical message ID) to arrive at the target USP endpoint.</p>
<p><strong>R-MSG.3</strong> – If a target USP endpoint receives a message with a duplicate message ID before it has processed and sent a Response or Error to the original message, it MUST gracefully ignore the duplicate message.</p>
<p>For messages that require no response, it is up to the target endpoint implementation when to allow the same message ID to be re-used by the same source USP endpoint.</p>
<h3 id="example-message-flows">Example Message Flows</h3>
<p><a id="example_message_flows" /></p>
<p>Successful request/response: In this successful message sequence, a Controller sends an Agent a request. The message header and body are parsed and the request is processed, and the Agent sends a response with the relevant information in the body.</p>
<p><img src="successful_response.png" /> Figure 1 – A successful request/response sequence</p>
<p>Failed request/response: In this failed message sequence, a Controller sends an Agent a request. The message header and body are parsed and the request is processed, but throws an error. The error arguments are generated and sent in an error message.</p>
<p><img src="error_response.png" /> Figure 2 – A failed request/response sequence</p>
<h2 id="message-structure">Message Structure</h2>
<p>A Message consists of a header and body. When using <a href="https://developers.google.com/protocol-buffers/docs/proto3" title="Protocol Buffers v3 Protocol Buffers Mechanism for Serializing Structured Data Version 3">protocol buffers</a>, the elements of the header and body for different messages are defined in a schema and sent in an encoded format from one USP endpoint to another.</p>
<p><strong>R-MSG.4</strong> – A Message MUST conform to the schemas defined in <a href="usp.proto" class="uri">usp.proto</a>.</p>
<p><em>Note: When using protocol buffers for message encoding, default values (when elements are missing) are described in <a href="https://developers.google.com/protocol-buffers/docs/proto3#default">Protcol Buffers v3</a>.</em></p>
<p>Every USP message contains a header and a body. The header contains basic destination and coordination information, and is separated to allow security and discovery mechanisms to operate. The body contains the message itself and its arguments.</p>
<p>Each of the message types and elements below are described with the element type according to <a href="https://developers.google.com/protocol-buffers/docs/proto3" title="Protocol Buffers v3 Protocol Buffers Mechanism for Serializing Structured Data Version 3">Protocol Buffers version 3</a>, followed by its name.</p>
<h3 id="the-usp-message">The USP Message</h3>
<p><a href="message_container" /></p>
<p><code>Header header</code></p>
<p><strong>R-MSG.5</strong> – A Message MUST contain exactly one header element.</p>
<p><code>Body body</code></p>
<p>The Message Body that must be present in every Message. The Body element contains either a Request, Response, or Error element.</p>
<p><strong>R-MSG.6</strong> – A Message MUST contain exactly one body element.</p>
<h3 id="message-header">Message Header</h3>
<p><a id="header" /></p>
<p>The message header contains information on source and target of the message, as well as useful coordination information. Its elements include a message ID, the endpoint identifiers for the source and target endpoints, an optional reply-to identifier, and a field indicating the type of message.</p>
<p>The purpose of the message header is to provide basic information necessary for the target endpoint to process the message.</p>
<h4 id="message-header-elements">Message Header Elements</h4>
<p><code>string msg_id</code></p>
<p>A locally unique opaque identifier assigned by the Endpoint that generated this message.</p>
<p><strong>R-MSG.7</strong> – The msg_id element MUST be present in every Header.</p>
<p><strong>R-MSG.8</strong> – The msg_id element in the Message Header for a Response or Error that is associated with a Request MUST contain the message ID of the associated request. If the msg_id element in the Response or Error does not contain the message ID of the associated Request, the response or error MUST be ignored.</p>
<p><code>enum MsgType msg_type</code></p>
<p>This element contains an enumeration indicating the type of message contained in the message body. It is an enumeration of:</p>
<pre><code>ERROR (0)
GET (1)
GET_RESP (2)
NOTIFY (3)
SET (4)
SET_RESP (5)
OPERATE (6)
OPERATE_RESP (7)
ADD (8)
ADD_RESP (9)
DELETE (10)
DELETE_RESP (11)
GET_OBJECTS (12)
GET_OBJECTS_RESP (13)
NOTIFY_RESP (14)</code></pre>
<p><strong>R-MSG.9</strong> – The <code>msg_type</code> element MUST be present in every Header.</p>
<p><code>string proto_version</code></p>
<p>The version of the USP protocol.</p>
<p><strong>R-MSG.10</strong> – The proto_version element MUST be present in every Header.</p>
<p><strong>R-MSG.11</strong> – The proto_version element MUST be set to a value of “<code>1.0</code>”.</p>
<p><code>string to_id</code></p>
<p>The value of this header argument is the Endpoint Identifier of the target Endpoint.</p>
<p><strong>R-MSG.12</strong> – The <code>to_id</code> element MUST be present in every Header.</p>
<p><strong>R-MSG.13</strong> – The target USP endpoint MUST ignore any message that does not contain its own Endpoint Identifier.</p>
<p><code>string from_id</code></p>
<p>The value of this header argument is the Endpoint Identifier of the source Endpoint.</p>
<p><strong>R-MSG.14</strong> – The <code>from_id</code> element MUST be present in every Header.</p>
<p><code>string reply_to_id</code></p>
<p>The value of this header argument is the Endpoint Identifier to which responses associated with this message should be targeted.</p>
<p><strong>R-MSG.15</strong> – The <code>reply_to_id</code> MAY be used to send Response or Error to a USP Endpoint other than the from-to-id in the Request.</p>
<p><em>Note: The reply-to endpoint should have prior knowledge of the message and can expect the Response or Error.</em></p>
<p><strong>R-MSG.16</strong> – The Source Endpoint MUST ignore a Response or Error message from a Target Endpoint when the Source Endpoint does not expect the Response or Error.</p>
<p><em>Note: The reply-to endpoint should have prior knowledge of the message and can expect the Response.</em></p>
<p><strong>R-MSG.17</strong> – The <code>reply_to_id</code> element is optional, and MUST NOT be present in a Message that contains either a Response or Error in the Body element.</p>
<p><strong>R-MSG.18</strong> – If the <code>reply_to_id</code> is omitted from a Message that contains a Request in the Body element, the response or Error MUST be sent to the Endpoint identified in the <code>from_id</code> element in the request’s Header element.</p>
<h3 id="message-body">Message Body</h3>
<p><a id="body" /></p>
<p>The message body contains the intended message and the appropriate elements for the message type.</p>
<p>Every message body contains exactly one message and its elements. When an Agent is the target endpoint, these messages can be used to create, read, update, and delete Objects, or execute Object-defined operations. When a Controller is the target endpoint, the message will contain a notification, response, or an error.</p>
<h4 id="message-body-elements">Message Body Elements</h4>
<p><code>oneof msg_body</code></p>
<p>This element contains one of the types given below.</p>
<p><code>Request request</code></p>
<p>This element indicates that the Message contains a request of a type given in the Request Message.</p>
<p><code>Response response</code></p>
<p>This element indicates that the Message contains a response of a type given in the Response Message.</p>
<p><code>Error  error</code></p>
<p>This element indicates that the Message contains an Error Message.</p>
<h4 id="request-elements">Request Elements</h4>
<p><a id="request" /></p>
<p><code>oneof req_type</code></p>
<p>This element contains one of the types given below. Each indicates that the Message contains a Message of the given type.</p>
<pre><code>Get get
GetObjects get_Objects
Set set
Add add
Delete delete
Operate operate
Notify notify</code></pre>
<h4 id="response-elements">Response Elements</h4>
<p><a id="response" /></p>
<p><code>oneof resp_type</code></p>
<p>This element contains one of the types given below. Each indicates that the Message contains a Message of the given type.</p>
<pre><code>GetResp get_resp
GetObjectsResp get_objects_resp
SetResp set_resp
AddResp add_resp        
DeleteResp delete_resp      
OperateResp operate_resp
NotifyResp notify_resp      </code></pre>
<h4 id="error-elements">Error Elements</h4>
<p><a id="error" /></p>
<p><code>fixed32 err_code</code></p>
<p>This element contains a <a href="/messages/error-codes/">numeric code</a> indicating the type of error that caused the overall message to fail.</p>
<p><code>string err_msg</code></p>
<p>This element contains additional information about the reason behind the error.</p>
<p><code>repeated ParamError param_err_list</code></p>
<p>This element is present in an Error Message in response to an Add or Set message when the allow_partial element is false and detailed error information is available for each Object or parameter that have caused the message to report an Error.</p>
<h5 id="paramerror-elements">ParamError Elements</h5>
<p><code>string param_path</code></p>
<p>This element contains a Path Name to the Object or parameter that caused the error.</p>
<p><code>fixed32 err_code</code></p>
<p>This element contains a <a href="/messages/error-codes/">numeric code</a> indicating the type of error that caused the message to fail.</p>
<p><code>string err_msg</code></p>
<p>This element contains additional information about the reason behind the error.</p>
<h2 id="creating-updating-and-deleting-objects">Creating, Updating, and Deleting Objects</h2>
<p>The <a href="./add">Add</a>, <a href="./set">Set</a>, and <a href="./delete">Delete</a> requests are used to create, configure and remove Objects that comprise Service Elements.</p>
<h2 id="reading-an-agents-state-and-capabilities">Reading an Agent’s State and Capabilities</h2>
<p>An Agent’s current state and capabilities are represented in its data model. The current state is referred to as its Instantiated Data Model, while the data model that represents its set of capabilities is referred to as its Supported Data Model. Messages exist to retrieve data from both the instantiated and Supported Data Models.</p>
<h3 id="getting-the-current-state">Getting the current state</h3>
<p>A Controller that wishes to learn the current state of an Agent usually wants to know one of two things: the current object instances that exist (and their unique keys for use in addressing), or the actual state of the Objects and Parameters represented by the Agent. These are handled by the <a href="getinstances/">GetInstances</a> message, and the <a href="get/">Get</a> message, respectively.</p>
<h3 id="getting-the-supported-data-model">Getting the Supported Data Model</h3>
<p>USP allows an Agent to specify which Objects, Parameters, Commands, and Events it supports in its Supported Data Model. The <a href="getsupporteddm/">GetSupportedDM</a> message allows a Controller to retrieve information about the Supported Data Model as part of a USP message. While the Device Type documents and the definitions therein still hold, this message lets the Controller and Agent synchronize on the Supported Data Model as part of USP operation.</p>
<h2 id="notifications-and-subscription-mechanism">Notifications and Subscription Mechanism</h2>
<p><a id="notifications" /></p>
<p>A Controller can use the Subscription mechanism to subscribe to certain events that occur on the Agent, such as a parameter change, Object removal, wake-up, etc. When such event conditions are met, the Agent sends a <a href="notify/">Notify message</a> to the Controller.</p>
<h2 id="defined-operations-mechanism">Defined Operations Mechanism</h2>
<p>Additional methods (operations) are and can be defined in the USP data model. Operations are generally defined on an Object, using the “command” attribute, as defined in <a href="https://www.broadband-forum.org/technical/download/TR-106_Amendment-8.pdf" title="TR-106 Amendment 8 Data Model Template for TR-069 Enabled Devices">TR-106</a>. The mechanism is controlled using the <a href="operate/">Operate message</a> in conjunction with the Multi-Instance Request Object.</p>
