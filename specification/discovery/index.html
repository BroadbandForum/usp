<!-- Reference Links -->
<h1 id="discovery-and-advertisement">Discovery and Advertisement</h1>
<p>Discovery is the process by which USP Endpoints learn the USP properties and MTP connection details of another Endpoint, either for sending USP Messages in the context of an existing relationship (where the Controller’s USP Endpoint Identifier, credentials, and authorized Role are all known to the Agent) or for the establishment of a new relationship. Advertisement is the process by which USP Endpoints make their presence known (or USP Endpoint presence is made known) to other USP Endpoints. Agents may also be pre-configured with some or all information about certain Controllers.</p>
<h2 id="learning-controller-and-agent-information">Learning Controller and Agent Information</h2>
<p><a id="learning_endpoint_information" /></p>
<h3 id="learning-controller-information">Learning Controller Information</h3>
<p>An Agent that has a USP relationship with a Controller needs to know that Controller’s Endpoint Identifier, credentials, and authorized Role. The authorized role may be a default “Untrusted” Role.</p>
<p>An Agent that has a USP relationship with a Controller needs to obtain information that allows it to determine the MTP, IP address, port, and resource path (if required by the MTP) of the Controller. This may be a URL with all of these components, a FQDN that resolves to provide all of these components via DNS-SD records, or mDNS discovery in the LAN.</p>
<p>Example mechanisms for configuration include but are not limited to:</p>
<ul>
<li>Pre-configured in firmware</li>
<li>Configured by an already-known-and-trusted Controller</li>
<li>Configured through a separate bootstrap mechanism such as a user interface or other management interface.</li>
<li>DHCP, DNS, or <a href="#mdns">mDNS discovery</a>.</li>
</ul>
<p><strong>R-DIS.0</strong> - An Agent that supports USP configuration of Controllers MUST implement the <code>Device.Localagent.Controller</code> Object as defined in <a href="https://www.broadband-forum.org/technical/download/TR-181_Issue-2_Amendment-12.pdf" title="TR-181 Issue 2 Device Data Model for TR-069">The Device:2 Data Model for TR-069 Devices and USP Agents</a>.</p>
<p>The Agent can be pre-configured with trusted root certificates or trusted certificates to allow authentication of Controllers. Other trust models are also possible, where an Agent without a current Controller association will trust the first discovered Controller, or where the Agent has a UI that allows a User to indicate whether a discovered Controller is authorized to configure that Agent.</p>
<h3 id="learning-agent-information">Learning Agent Information</h3>
<p>A Controller that has a relationship with an Agent needs to know the Agent’s Endpoint Identifier, connectivity information for the Agent’s MTP(s), and credentials.</p>
<p>Controllers acquires this information upon initial connection by an Agent, though a LAN based Controller may acquire an Agent’s MTP information through mDNS Discovery. It is each Controller’s responsibility to maintain a record of known Agents.</p>
<h2 id="dhcp-options-for-acquiring-controller-information">DHCP Options for Acquiring Controller Information</h2>
<p><a id="dhcp" /></p>
<p>DHCP can be employed as a method for Agents to discover Controllers. The DHCPv4 Vendor-Identifying Vendor-Specific Information Option <a href="https://tools.ietf.org/html/rfc3925">RFC 3925</a> (option code 125) and DHCPv6 Vendor-specific Information Option <a href="https://tools.ietf.org/html/rfc3315">RFC 3315</a> (option code 17) can be used to provide information to Agents about a single Controller. The options that may be returned by DNS are shown below. Description of these options can be found in <a href="https://www.broadband-forum.org/technical/download/TR-181_Issue-2_Amendment-12.pdf" title="TR-181 Issue 2 Device Data Model for TR-069">Device:2</a>.</p>
<p><strong>R-DIS.1</strong> - If an Agent is configured to request Controller DHCP information, the Agent MUST include in its DHCPv4 requests a DHCPv4 V-I Vendor Class Option (option 124) and in its DHCPv6 requests a DHCPv6 Vendor Class (option 16). This option MUST include the Broadband Forum Enterprise Number (<code>3561</code> decimal, <code>0x0DE9</code> hex) as an enterprise-number, and the string “<code>usp</code>” (all lower case) in a vendor-class-data instance associated with this enterprise-number.</p>
<p>The Role to associate with DHCP-discovered Controller is programmatically determined (see (Security)[../security]).</p>
<p><strong>R-DIS.2</strong> - If the URL provided by DHCP includes the FQDN of a Controller, the Agent MUST use <a href="#dns">DNS</a> to retrieve additional Controller information.</p>
<p>ISPs are advised to limit the use of DHCP for configuration of a Controller to situations in which the security of the link between the DHCP server and the Agent can be assured by the service provider. Since DHCP does not itself incorporate a security mechanism, it is a good idea to use pre-configured certificates or other means of establishing trust between the Agent and a Controller discovered by DHCP.</p>
<h3 id="dhcp-options-for-controller-discovery">DHCP Options for Controller Discovery</h3>
<table style="width:65%;">
<colgroup>
<col width="16%" />
<col width="16%" />
<col width="18%" />
<col width="13%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">Encapsulated Option</th>
<th align="center">DHCPv4 Option 125</th>
<th align="center">DHCPv6 Option 17</th>
<th align="left">Parameter in <a href="https://www.broadband-forum.org/technical/download/TR-181_Issue-2_Amendment-12.pdf" title="TR-181 Issue 2 Device Data Model for TR-069">Device:2</a></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">URL of the Controller</td>
<td align="center"><code>25</code></td>
<td align="center"><code>25</code></td>
<td align="left"><code>Device.LocalAgent.Controller.{i}.MTP.{i}.*.URL</code></td>
</tr>
<tr class="even">
<td align="right">Provisioning code</td>
<td align="center"><code>26</code></td>
<td align="center"><code>26</code></td>
<td align="left"><code>Device.LocalAgent.Controller.{i}.ProvisioningCode</code></td>
</tr>
<tr class="odd">
<td align="right">USP retry mini¬mum wait interval</td>
<td align="center"><code>27</code></td>
<td align="center"><code>27</code></td>
<td align="left"><code>Device.Controller.{i}.USPRetryMinimumWaitInterval</code></td>
</tr>
<tr class="even">
<td align="right">USP retry interval multiplier</td>
<td align="center"><code>28</code></td>
<td align="center"><code>28</code></td>
<td align="left"><code>Device.Controller.{i}.USPRetryIntervalMultiplier</code></td>
</tr>
</tbody>
</table>
<h2 id="mdns">mDNS</h2>
<p><a id="mdns" /></p>
<p><strong>R-DIS.3</strong> - If mDNS discovery is supported by a USP Endpoint, the USP Endpoint MUST implement mDNS client and server functionality as defined in <a href="https://tools.ietf.org/html/rfc6762" title="RFC 6762 Multicast DNS">RFC 6762</a>.</p>
<p><strong>R-DIS.4</strong> - If mDNS advertisement for a MTP is enabled on an Endpoint, the Endpoint MUST listen for messages using that MTP from other Endpoints requesting establishment of USP communication over that MTP.</p>
<p><em>/Barbara to update this/</em></p>
<p><strong>R-DIS.10</strong> - If mDNS is enabled, an USP Endpoint MUST use mDNS to resolve a FQDN with domain “<code>.local.</code>”.</p>
<h3 id="dns">DNS</h3>
<p><a id="dns" /></p>
<p>Requirements for implementation of a DNS client and configuration of the DNS client with DNS server address(es) (through static configuration, DHCPv4, DHCPv6, or Router Solicitation) are not provided. These are sufficiently well-known that they were not considered necessary for this specification. If the Agent knows of no DNS Server, it cannot do DNS resolution.</p>
<p><strong>R-DIS.6</strong> - If DNS is enabled, an Endpoint MUST use DNS to resolve a FQDN with domain other than ones used for mDNS (R-DIS.10)</p>
<p><strong>R-DIS.7</strong> - If the Agent is resolving an FQDN for a Controller, and the MTP or resource path are unknown, the Agent MUST request DNS-SD information (PTR, SRV and TXT resource records) in addition to A, AAAA or other resource records it is programmatically set to request.</p>
<h3 id="dns-sd-records">DNS-SD Records</h3>
<p><a id="dns-sd" /></p>
<p>DNS Service Discovery (DNS-SD) <a href="https://tools.ietf.org/html/rfc6763" title="RFC 6763 DNS-Based Service Discovery">RFC 6763</a> is a mechanism for naming and structuring of DNS resource records to facilitate service discovery. It can be used to create DNS records for USP Endpoints, so they can be discoverable via DNS PTR queries <a href="https://www.ietf.org/rfc/rfc1035.txt">RFC 1035</a> or Multicast DNS (mDNS) <a href="https://tools.ietf.org/html/rfc6762" title="RFC 6762 Multicast DNS">RFC 6762</a>. DNS-SD uses DNS SRV and TXT records to express information about “services”, and DNS PTR records to help locate the SRV and TXT records. To discover these DNS records, DNS or mDNS queries can be used. [RFC 6762] recommends using the query type PTR to get both the SRV and TXT records. A and AAAA records will also be returned, for address resolution.</p>
<p>The format of a DNS-SD Service Instance Name (which is the resource record (RR) Name of the DNS SRV and TXT records) is “<code>&lt;Instance&gt;.&lt;Service&gt;.&lt;Domain&gt;</code>“. <code>&lt;Instance&gt;</code> will be the USP Identifier of the USP Endpoint.</p>
<p><strong>R-DIS.8</strong> - USP Endpoint DNS-SD records MUST include the USP Identifier of the USP Endpoint as the DNS-SD Service Instance Name. Service Name values <a href="http://www.broadband-forum.org/assignments%5D">registered by BBF with IANA</a> used by USP are shown below. As described in <a href="https://tools.ietf.org/html/rfc6763" title="RFC 6763 DNS-Based Service Discovery">RFC 6763</a>, the <code>&lt;Service&gt;</code> part of a Service Instance Name is constructed from these values as “<code>_&lt;Service Name&gt;._&lt;Transport Protocol&gt;</code>” (e.g., “<code>_usp-agt-coap._udp</code>”).</p>
<h4 id="iana-registered-usp-service-names">IANA-Registered USP Service Names</h4>
<table>
<thead>
<tr class="header">
<th align="right">Service Name</th>
<th align="center">Transport Protocol</th>
<th align="center">MTP</th>
<th align="left">Type of USP Endpoint</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right"><code>usp-agt-coap</code></td>
<td align="center">udp</td>
<td align="center">CoAP</td>
<td align="left">Agent</td>
</tr>
<tr class="even">
<td align="right"><code>usp-ctr-coap</code></td>
<td align="center">udp</td>
<td align="center">CoAP</td>
<td align="left">Controller</td>
</tr>
</tbody>
</table>
<!--
| `usp-agt-http` | tcp | HTTP | Agent |
| `usp-ctr-http` | tcp | HTTP | Controller |
| `usp-agt-stomp` | tcp | STOMP | Agent |
| `usp-ctr-stomp` | tcp | STOMP | Controller |
-->
<p>DNS PTR records with a service subtype identifier (e.g., <code>._&lt;subtype&gt;._usp-agt-coap._udp.&lt;Domain&gt;</code>) in the RR can be used to provide searchable simple (single layer) functional groupings of USP Agents. The registry of subtypes for Service Names registered by BBF is listed at http://www.broadband-forum.org/assignments. DNS SRV and TXT records can be pointed to by multiple PTR records, which allow a USP Endpoint to potentially be discoverable as belonging to various functional groupings.</p>
<p>DNS TXT records allow for a small set of additional information to be included in the reply sent to the querier. This information cannot be used as search criteria. The registry of TXT record attributes for BBF Service Names are listed at http://www.broadband-forum.org/assignments.</p>
<p><strong>R-DIS.9</strong> - Agent DNS-SD records MUST include a TXT record with the “path” and “name” attributes.</p>
<p><strong>R-DIS.10</strong> - The “name” attribute included in the Agent DNS-SD records MUST be identical to the .FriendlyName parameter defined in <a href="https://www.broadband-forum.org/technical/download/TR-181_Issue-2_Amendment-12.pdf" title="TR-181 Issue 2 Device Data Model for TR-069">Device:2</a>, if the FriendlyName parameter is implemented.</p>
<p><strong>R-DIS.11</strong> - Controller DNS-SD records MUST include a TXT record with the “path” attribute.</p>
<p>The “path” attribute is dependent on each Message Transfer Protocol, and the specific requirements are outlined in the appropriate Annex of this document.</p>
<p>The TXT record can include other attributes defined in the TXT record attribute registry, as well.</p>
<p>Whether a particular USP Endpoint respond to DNS or mDNS queries or populates (through configuration or mDNS advertisement) their information in a local DNS-SD server can be a configured option that can be enabled/disabled, depending on the intended deployment usage scenario.</p>
<h3 id="example-controller-unicast-dns-sd-resource-records">Example Controller Unicast DNS-SD Resource Records</h3>
<pre><code>    ; One PTR record for each supported MTP
    _usp-ctr-http._tcp.host.example.com      PTR &lt;Controller USP ID&gt;._usp-ctr-http._tcp.example.com.

    ; One SRV+TXT (DNS-SD Service Instance) record for each supported MTP
    &lt;USP ID&gt;._usp-ctr-http._tcp.example.com.   SRV 0 1 443 host.example.com.
    &lt;USP ID&gt;._usp-ctr-http._tcp.example.com.   TXT “path=&lt;pathname&gt;“

    ; Controller A and AAAA records
    host.example.com.  A      192.0.2.200
    host.example.com.  AAAA   2001:db8::200</code></pre>
<h3 id="example-agent-multicast-dns-sd-resource-records">Example Agent Multicast DNS-SD Resource Records</h3>
<pre><code>    ; One PTR record (DNS-SD Service) for each supported MTP
    _usp-agt-http._tcp                 PTR &lt;USP ID&gt;._usp-agt-http._tcp.local.
    _usp-agt-coap._udp                 PTR &lt;USP ID&gt;._usp-agt-coap._udp.local.

    ; One PTR record (DNS-SD Service Subtype) for each supported MTP per device type
    _iot-device._sub._usp-agt-http._tcp    PTR &lt;USP ID&gt;._usp-agt-http._tcp.local.
    _gateway._sub._usp-agt-http._tcp       PTR &lt;USP ID&gt;._usp-agt-http._tcp.local.
    _iot-device._sub._usp-agt-coap._udp    PTR &lt;USP ID&gt;._usp-agt-coap._udp.local.
    _gateway._sub._usp-agt-coap._udp       PTR &lt;USP ID&gt;._usp-agt-coap._udp.local.

    ; One SRV+TXT record (DNS-SD Service Instance) for each supported MTP
    &lt;USP ID&gt;._usp-agt-http._tcp.local.    SRV 0 1 443 &lt;USP ID&gt;.local.
    &lt;USP ID&gt;._usp-agt-http._tcp.local.    TXT “path=&lt;pathname&gt;“ “name=kitchen light”
    &lt;USP ID&gt;._usp-agt-coap._udp.local.    SRV 0 1 5694 &lt;Agent USP ID&gt;.local.
    &lt;USP ID&gt;._usp-agt-coap._udp.local.    TXT “path=&lt;pathname&gt;“ “name=kitchen light”

    ; Agent A and AAAA records
    &lt;USP ID&gt;.local.  A      192.0.2.100
    &lt;USP ID&gt;.local.  AAAA   2001:db8::100</code></pre>
<h3 id="example-controller-multicast-dns-sd-resource-records">Example Controller Multicast DNS-SD Resource Records</h3>
<p>LAN Controllers do not need to have PTR records, as they will only be queried using the DNS-SD instance identifier of the Controller.</p>
<pre><code>    ; One SRV+TXT record (DNS-SD Service Instance) for each supported MTP
    &lt;USP ID&gt;._usp-ctr-coap._tcp.local.    SRV 0 1 443 &lt;USP ID&gt;.local.
    &lt;USP ID&gt;._usp-ctr-coap._tcp.local.    TXT “path=&lt;pathname&gt;“

    ; Controller A and AAAA records
    &lt;USP ID&gt;.local.  A      192.0.2.200
    &lt;USP ID&gt;.local.  AAAA   2001:db8::200</code></pre>
<h2 id="using-the-sendonboardrequest-operation-and-onboardrequest-notification">Using the SendOnBoardRequest() operation and OnBoardRequest notification</h2>
<p>An &quot;OnBoardRequest&quot; notification can be sent by an Agent to a Controller to begin an on-boarding process (for example, when the Agent first comes online and discovers a Controller using DHCP). Its use is largely driven by policy, but there is a mechanism other Controllers can use to ask an Agent to send &quot;OnBoardRequest&quot; to another Controller: the SendOnBoardRequest() command is defined in the <a href="https://www.broadband-forum.org/technical/download/TR-181_Issue-2_Amendment-12.pdf" title="TR-181 Issue 2 Device Data Model for TR-069">Device:2</a>. See section on notify messages for additional information about the OnBoardRequest notification.</p>
