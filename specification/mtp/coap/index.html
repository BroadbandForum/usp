<!-- Reference Links -->
<h1 id="coap-binding">CoAP Binding</h1>
<p>The Constrained Application Protocol (CoAP) MTP transfers USP messages between USP endpoints using the CoAP protocol as defined in <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a>. Messages that are transferred between CoAP clients and servers utilize a request/response messaging interaction based on RESTful architectural principles. The following figure depicts the transfer of the USP messages between USP controllers and agents.</p>
<p><img src="usp-message-over-coap.png" /> Figure 1 – A USP message over the CoAP MTP</p>
<p>USP messages that originate from USP Controllers are encapsulated within a CoAP request message. When a USP Agent receives the CoAP request message the USP Agent sends a CoAP response message to the USP Controller that indicates receipt of the message. When the USP Agent responds to the USP Controller's request, the Agent encapsulates the USP response in a new CoAP request message. When the USP Controller receives the USP response, the USP Controller sends a CoAP response message that indicates receipt of the message.</p>
<p>In addition to the USP Requests that are exchanged between USP Controllers and Agents, the USP Notify Request from a USP Agent to one or more Controllers utilizes the same message pattern described in <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a> except the roles played by the CoAP endpoint are modified. The USP Agent plays the role of the CoAP client and the USP Controller plays the role of the CoAP server. When a USP Controller subscribes to receive notifications from a USP Agent, the USP Agent transmits the USP notification using the CoAP message as depicted in the following figure.</p>
<p><img src="usp-notify-over-coap.png" /> Figure 2 – USP Notifications over CoAP</p>
<h2 id="mapping-usp-endpoints-to-coap-uris">Mapping USP Endpoints to CoAP URIs</h2>
<p><a id="mapping_usp_endpoints_to_coap_uri" /></p>
<p>Section 6 of <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a> discusses the URI schemes for identifying CoAP resources and provides a means of locating the resource. These resources are organized hierarchically and governed by a CoAP server listening for CoAP requests on a given port. USP Endpoints are one type of CoAP resource that is identified and discovered.</p>
<p><strong>R-COAP.0</strong> - As the USP Endpoint is a resource governed by a CoAP server, the CoAP server MUST also be identified as defined in section 6 of <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a>.</p>
<p><strong>R-COAP.1</strong> - A USP Endpoint MUST be represented as a CoAP resource with the following resource attributes: * Identifier within the CoAP server (uri-path) * Resource type (rt): “<code>usp.endpoint</code>” * Interface (if): &quot;<code>usp.c</code>&quot; for USP Controller or “<code>usp.a</code>” for USP Agent</p>
<p>The identifier within the CoAP server is used to deliver messages to the USP Endpoint. When this identifier is used to deliver messages to the USP Endpoint, this identifier is a uri-path that represents the the USP Endpoint Identifier. For example: “<code>/e/{endpointId}</code>”</p>
<h2 id="mapping-usp-messages-to-coap-messages">Mapping USP Messages to CoAP Messages</h2>
<p><a id="mapping_usp_messages_to_coap_messages" /></p>
<p><strong>R-COAP.2</strong> - In order for USP Messages to be transferred between a USP Controller and Agent using CoAP, the USP Message MUST be encapsulated within the CoAP message as defined in <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a>.</p>
<p><strong>R-COAP.3</strong> - USP Messages that exceed the CoAP message size MUST be block encapsulated in accordance with <a href="https://www.rfc-editor.org/rfc/rfc7959.txt">draft-ietf-core-block</a>.</p>
<p>USP Messages are transferred using the CoAP resource that represents the receiving USP Endpoint using the CoAP POST method as defined in <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a>.</p>
<p><strong>R-COAP.4</strong> - The CoAP Content-Format for USP Messages MUST be <code>application/octet-stream (ID=42)</code> for <a href="/mtp">protobuf encoding</a>.</p>
<h3 id="handling-coap-request-success">Handling CoAP Request Success</h3>
<p><a id="handling_coap_request_success" /></p>
<p><strong>R-COAP.5</strong> - Upon successful reception of the CoAP message using POST, the CoAP server MUST respond with a response code of <code>2.04 (Changed)</code>.</p>
<h3 id="handling-coap-request-failures">Handling CoAP Request Failures</h3>
<p><a id="handling_coap_request_failures" /></p>
<p>At times CoAP requests fail to complete due to problems in the underlying transport (e.g., timeout) or a failure response code received from the CoAP server due to problems in the CoAP request sent by the CoAP client (4.xx) or problems with the CoAP server implementation (5.xx).</p>
<p><strong>R-COAP.6</strong> - CoAP clients and servers MUST implement the required CoAP response codes defined in section 5.9 of <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a>.</p>
<p><strong>R-COAP.7</strong> - When a CoAP client receives a failure indication (e.g., timeout) from the underlying transport layer, the CoAP client MUST indicate a timeout to the USP Endpoint.</p>
<p><strong>R-COAP.8</strong> - When a CoAP client receives a failure indication (e.g., timeout) from the underlying transport layer, the CoAP client MUST indicate a timeout to the USP Endpoint.</p>
<p><strong>R-COAP.9</strong> - When a CoAP client receives a response code of 4.xx or 5.xx, the CoAP client MUST indicate a CoAP failure to the USP Endpoint.</p>
<p>When a CoAP client sends a CoAP request, the CoAP client can provide incorrect or missing information in the CoAP request. For example, a CoAP client can send a CoAP request with an:</p>
<ul>
<li>Invalid CoAP method: The CoAP server responds with a <code>4.05</code></li>
<li>Invalid Content-Format options: The CoAP server responds with a <code>4.15</code></li>
<li>Invalid or not understandable payload: The CoAP server responds with a <code>4.00</code></li>
</ul>
<p><strong>R-COAP.10</strong> - When a CoAP server receives a CoAP request with an invalid CoAP method, the CoAP server MUST respond with a <code>4.05</code> response code.</p>
<p><strong>R-COAP.11</strong> - When a CoAP server receives a CoAP request with an invalid CoAP Content-Format option, the CoAP server MUST respond with a <code>4.15</code> response code.</p>
<p><strong>R-COAP.12</strong> - When a CoAP server receives a CoAP request and the receiving USP Endpoint cannot interpret or decode the USP Message for processing, the CoAP server MUST respond with a <code>4.00</code> response code.</p>
<h2 id="mapping-usp-notification-message-to-coap-message">Mapping USP Notification Message to CoAP Message</h2>
<p><a id="mapping_usp_notification_message_to_coap_message" /></p>
<p>The USP Notify Request is the only message of the Request type that is sent from an Agent to a Controller. In these cases, the Agent functions as a CoAP client rather than a CoAP server in the POST/Response sequence.</p>
<p><strong>R-COAP.13</strong> - When a CoAP server receives a USP Notify Request, the CoAP server MUST adhere to the requirements defined in <a href="#mapping_usp_messages_to_coap_messages">Mapping USP Messages to CoAP Messages</a>.</p>
<h2 id="mtp-message-encryption">MTP Message Encryption</h2>
<p>CoAP MTP message encryption is provided using DTLS as described in Section 9 of <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a>.</p>
<p>In section 9 of <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a>, CoAP messages are secured using one of three modes:</p>
<ul>
<li>NoSec: DTLS is disabled</li>
<li>PreSharedKey: DTLS is enabled and the MTP endpoint uses pre-shared keys that are used to validate the identity of CoAP endpoints involved in the message exchange</li>
<li>RawPublicKey: DTLS is enabled and the MTP endpoint has an asymmetric key pair without a certificate. The MTP endpoint has an identity calculated from the public key and a list of other MTP endpoints to which it can communicate</li>
<li>Certificate: DTLS is enabled and the MTP endpoint has an asymmetric key pair with an X.509 certificate.</li>
</ul>
<p><strong>R-COAP.14</strong> - CoAP clients and servers MUST implement the NoSec and Certificate modes of CoAP security as defined in RFC 7252.</p>
<p>While section 9 of <a href="https://tools.ietf.org/html/rfc7252" title="RFC 7252 The Constrained Application Protocol (CoAP)">RFC 7252</a> provides guidance on securing CoAP, further guidance related to DTLS implementations for the Internet of Things is provided by <a href="https://tools.ietf.org/html/rfc7925">RFC 7925</a>.</p>
<p><strong>R-COAP.15</strong> - CoAP clients and servers MUST implement the mandatory statements of <a href="https://tools.ietf.org/html/rfc7925">RFC 7925</a> with the exception that:</p>
<ul>
<li>Section 4.4.1 USP Controller certificates can contain domain names with wildcard characters per <a href="https://tools.ietf.org/html/rfc6125">RFC 6125</a> guidance.</li>
<li>Section 4.4.2 Client certificate identifiers do not use EUI-64 identifier but instead use the identifier defined for Client certificates in this Working Text.</li>
<li>Section 4.4.5 Client Certificate URLs are not required to be implemented.</li>
</ul>
