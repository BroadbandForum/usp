<!DOCTYPE html>
<!-- BBF GitHub Pages pandoc template; modified from default.html template -->
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8"/>
  <meta name="generator" content="pandoc"/>
  <meta name="description" content="TR-369a2 – User Services Platform (USP): A standardized protocol to manage, monitor, update, and control connected devices, IoT endpoints, user services and home networks"/>
  <meta name="theme-color" content="#157878"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/>
  <title>BBF – 4 Message Transfer Protocols</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="github.css"/>
  <link rel="stylesheet" href="extra.css"/>
  <link rel="stylesheet" href="toc.css"/>
  <link rel="stylesheet" href="release.css"/>
  <link rel="stylesheet" href="local.css"/>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <!-- XXX header includes are included just before the ToC (below) -->
</head>

<body>
  <section class="page-header">
    <h1 class="project-name">
      <a href="../index.html" style="text-decoration: none; color: white;">
        <img src="bbflogo-reverse-dark.png"/><br>
        The User Services Platform
      </a>
    </h1>
    <h2 class="project-tagline">A standardized protocol to manage, monitor, update, and control connected devices, IoT endpoints, user services and home networks</h2>
    <p></p>
    <p></p>
    <div class="project-buttons">
      <a class="btn" href="../specification/index.html" title="USP Specification">Specification</a>
      <a class="btn" href="../specification/index.htm" title="USP Specification Single-file HTML">HTML</a>
      <a class="btn" href="../specification/index.pdf" title="USP Specification PDF">PDF</a>
      <a class="btn" href="https://usp-data-models.broadband-forum.org" title="USP Data Models">Data Models</a>
      <a class="btn" href="https://usp-test.broadband-forum.org" title="USP Test Plan">Test Plan</a>
      <a class="btn" href="../resources/01-index-usp-development-resources.html" title="USP Development Resources">Resources</a>
      <a class="btn" href="../faq/01-index-faq.html" title="USP Frequently Asked Questions">FAQ</a>
    </div>
  </section>

  <section class="main-content">
<nav>
<p>
   <a href="00-index-contents.html#contents">Cover Page</a>
 | <a href="01-index-introduction.html#sec:introduction">1 Introduction</a>
 | <a href="02-index-architecture.html#sec:architecture">2 Architecture</a>
 | <a href="03-index-discovery.html#sec:discovery">3 Discovery and Advertisement</a>
 | <a href="04-index-mtp.html#sec:mtp">4 Message Transfer Protocols</a>
 | <a href="05-index-encoding.html#sec:encoding">5 Message Encoding</a>
 | <a href="06-index-e2e-message-exchange.html#sec:e2e-message-exchange">6 End to End Message Exchange</a>
 | <a href="07-index-messages.html#sec:messages">7 Messages</a>
 | <a href="08-index-auth.html#sec:auth">8 Authentication and Authorization</a>
 | <a href="09-index-bulk-data-collection.html#sec:bulk-data-collection">Annex A: Bulk Data Collection</a>
 | <a href="10-index-software-module-management.html#sec:software-module-management">Appendix I: Software Module Management</a>
 | <a href="11-index-firmware-management-of-devices-with-usp-agents.html#sec:firmware-management-of-devices-with-usp-agents">Appendix II: Firmware Management of Devices with USP Agents</a>
 | <a href="12-index-device-proxy.html#sec:device-proxy">Appendix III: Device Proxy</a>
 | <a href="13-index-proxying.html#sec:proxying">Appendix IV: Proxying</a>
 | <a href="14-index-iot-data-model-theory-of-operation.html#sec:iot-data-model-theory-of-operation">Appendix V: IoT Data Model Theory of Operation</a>
 | <a href="99-index-footnotes.html#footnotes">Footnotes</a>
</p>
</nav>

<nav id="TOCFULL">
<ul>
  <li><a href="00-index-contents.html#contents">Cover Page</a></li>
  <li><a href="01-index-introduction.html#sec:introduction">1 Introduction</a></li>
  <ul>
    <li><a href="01-index-introduction.html#sec:executive-summary">1.1 Executive Summary</a></li>
    <li><a href="01-index-introduction.html#sec:purpose-and-scope">1.2 Purpose and Scope</a></li>
    <li><a href="01-index-introduction.html#sec:references-and-terminology">1.3 References and Terminology</a></li>
    <li><a href="01-index-introduction.html#sec:definitions">1.4 Definitions</a></li>
    <li><a href="01-index-introduction.html#sec:abbreviations">1.5 Abbreviations</a></li>
    <li><a href="01-index-introduction.html#sec:specification-impact">1.6 Specification Impact</a></li>
  </ul>
  <li><a href="02-index-architecture.html#sec:architecture">2 Architecture</a></li>
  <ul>
    <li><a href="02-index-architecture.html#sec:endpoints">2.1 Endpoints</a></li>
    <li><a href="02-index-architecture.html#sec:endpoint-identifier">2.2 Endpoint Identifier</a></li>
    <li><a href="02-index-architecture.html#sec:service-elements">2.3 Service Elements</a></li>
    <li><a href="02-index-architecture.html#sec:data-models">2.4 Data Models</a></li>
    <li><a href="02-index-architecture.html#sec:path-names">2.5 Path Names</a></li>
    <li><a href="02-index-architecture.html#sec:other-path-decorators">2.6 Other Path Decorators</a></li>
    <li><a href="02-index-architecture.html#sec:data-model-path-grammar">2.7 Data Model Path Grammar</a></li>
  </ul>
  <li><a href="03-index-discovery.html#sec:discovery">3 Discovery and Advertisement</a></li>
  <ul>
    <li><a href="03-index-discovery.html#sec:controller-information">3.1 Controller Information</a></li>
    <li><a href="03-index-discovery.html#sec:required-agent-information">3.2 Required Agent Information</a></li>
    <li><a href="03-index-discovery.html#sec:using-dhcp">3.3 Use of DHCP for Acquiring Controller Information</a></li>
    <li><a href="03-index-discovery.html#sec:using-mdns">3.4 Using mDNS</a></li>
    <li><a href="03-index-discovery.html#sec:using-dns">3.5 Using DNS</a></li>
    <li><a href="03-index-discovery.html#sec:dns-sd-records">3.6 DNS-SD Records</a></li>
    <li><a href="03-index-discovery.html#sec:using-the-sendonboardrequest-operation-and-onboardrequest-notification">3.7 Using the SendOnBoardRequest() operation and OnBoardRequest notification</a></li>
  </ul>
  <li><a href="04-index-mtp.html#sec:mtp">4 Message Transfer Protocols</a></li>
  <ul>
    <li><a href="04-index-mtp.html#sec:generic-requirements">4.1 Generic Requirements</a></li>
    <li><a href="04-index-mtp.html#sec:coap-binding-deprecated">4.2 CoAP Binding (DEPRECATED)</a></li>
    <li><a href="04-index-mtp.html#sec:websocket">4.3 WebSocket Binding</a></li>
    <li><a href="04-index-mtp.html#sec:stomp-binding">4.4 STOMP Binding</a></li>
    <li><a href="04-index-mtp.html#sec:mqtt-binding">4.5 MQTT Binding</a></li>
  </ul>
  <li><a href="05-index-encoding.html#sec:encoding">5 Message Encoding</a></li>
  <ul>
    <li><a href="05-index-encoding.html#sec:parameter-value-encoding">5.1 Parameter and Argument Value Encoding</a></li>
  </ul>
  <li><a href="06-index-e2e-message-exchange.html#sec:e2e-message-exchange">6 End to End Message Exchange</a></li>
  <ul>
    <li><a href="06-index-e2e-message-exchange.html#sec:exchange-of-usp-records-within-an-e2e-session-context">6.1 Exchange of USP Records within an E2E Session Context</a></li>
    <li><a href="06-index-e2e-message-exchange.html#sec:exchange-of-usp-records-without-an-e2e-session-context">6.2 Exchange of USP Records without an E2E Session Context</a></li>
    <li><a href="06-index-e2e-message-exchange.html#sec:validating-the-integrity-of-the-usp-record">6.3 Validating the Integrity of the USP Record</a></li>
    <li><a href="06-index-e2e-message-exchange.html#sec:secure-message-exchange">6.4 Secure Message Exchange</a></li>
  </ul>
  <li><a href="07-index-messages.html#sec:messages">7 Messages</a></li>
  <ul>
    <li><a href="07-index-messages.html#sec:encapsulation-in-a-usp-record">7.1 Encapsulation in a USP Record</a></li>
    <li><a href="07-index-messages.html#sec:requests-responses-and-errors">7.2 Requests, Responses and Errors</a></li>
    <li><a href="07-index-messages.html#sec:message-structure">7.3 Message Structure</a></li>
    <li><a href="07-index-messages.html#sec:creating-updating-and-deleting-objects">7.4 Creating, Updating, and Deleting Objects</a></li>
    <li><a href="07-index-messages.html#sec:reading-an-agents-state-and-capabilities">7.5 Reading an Agent’s State and Capabilities</a></li>
    <li><a href="07-index-messages.html#sec:notifications-and-subscriptions">7.6 Notifications and Subscription Mechanism</a></li>
    <li><a href="07-index-messages.html#sec:defined-operations-mechanism">7.7 Defined Operations Mechanism</a></li>
    <li><a href="07-index-messages.html#sec:error-codes">7.8 Error Codes</a></li>
  </ul>
  <li><a href="08-index-auth.html#sec:auth">8 Authentication and Authorization</a></li>
  <ul>
    <li><a href="08-index-auth.html#sec:authentication-1">8.1 Authentication</a></li>
    <li><a href="08-index-auth.html#sec:role-based-access-control-rbac">8.2 Role Based Access Control (RBAC)</a></li>
    <li><a href="08-index-auth.html#sec:trusted-certificate-authorities">8.3 Trusted Certificate Authorities</a></li>
    <li><a href="08-index-auth.html#sec:trusted-brokers">8.4 Trusted Brokers</a></li>
    <li><a href="08-index-auth.html#sec:self-signed-certificates">8.5 Self-Signed Certificates</a></li>
    <li><a href="08-index-auth.html#sec:agent-authentication">8.6 Agent Authentication</a></li>
    <li><a href="08-index-auth.html#sec:challenge-strings-and-images">8.7 Challenge Strings and Images</a></li>
    <li><a href="08-index-auth.html#sec:analysis-controller-certificates">8.8 Analysis of Controller Certificates</a></li>
    <li><a href="08-index-auth.html#sec:theory-of-operations">8.9 Theory of Operations</a></li>
  </ul>
  <li><a href="09-index-bulk-data-collection.html#sec:bulk-data-collection">Annex A: Bulk Data Collection</a></li>
  <ul>
    <li><a href="09-index-bulk-data-collection.html#sec:introduction-1">A.1 Introduction</a></li>
    <li><a href="09-index-bulk-data-collection.html#sec:http-bulk-data-collection">A.2 HTTP Bulk Data Collection</a></li>
    <li><a href="09-index-bulk-data-collection.html#sec:mqtt-bulk-data-collection">A.3 MQTT Bulk Data Collection</a></li>
    <li><a href="09-index-bulk-data-collection.html#sec:uspeventnotif-bulk-data-collection">A.4 USPEventNotif Bulk Data Collection</a></li>
    <li><a href="09-index-bulk-data-collection.html#sec:using-wildcards-to-reference-object-instances-in-the-report">A.5 Using Wildcards to Reference Object Instances in the Report</a></li>
    <li><a href="09-index-bulk-data-collection.html#sec:using-alternative-names-in-the-report">A.6 Using Alternative Names in the Report</a></li>
    <li><a href="09-index-bulk-data-collection.html#sec:encoding-of-bulk-data">A.7 Encoding of Bulk Data</a></li>
  </ul>
  <li><a href="10-index-software-module-management.html#sec:software-module-management">Appendix I: Software Module Management</a></li>
  <ul>
    <li><a href="10-index-software-module-management.html#sec:lifecycle-management">I.1 Lifecycle Management</a></li>
    <li><a href="10-index-software-module-management.html#sec:software-modules">I.2 Software Modules</a></li>
    <li><a href="10-index-software-module-management.html#sec:execution-environment-concepts">I.3 Execution Environment Concepts</a></li>
    <li><a href="10-index-software-module-management.html#sec:fault-model">I.4 Fault Model</a></li>
  </ul>
  <li><a href="11-index-firmware-management-of-devices-with-usp-agents.html#sec:firmware-management-of-devices-with-usp-agents">Appendix II: Firmware Management of Devices with USP Agents</a></li>
  <ul>
    <li><a href="11-index-firmware-management-of-devices-with-usp-agents.html#sec:getting-the-firmware-image-onto-the-device">II.1 Getting the firmware image onto the device</a></li>
    <li><a href="11-index-firmware-management-of-devices-with-usp-agents.html#sec:using-multiple-firmware-images">II.2 Using multiple firmware images</a></li>
  </ul>
  <li><a href="12-index-device-proxy.html#sec:device-proxy">Appendix III: Device Proxy</a></li>
  <li><a href="13-index-proxying.html#sec:proxying">Appendix IV: Proxying</a></li>
  <ul>
    <li><a href="13-index-proxying.html#sec:proxying-building-block-functions">IV.1 Proxying Building Block Functions</a></li>
    <li><a href="13-index-proxying.html#sec:discovery-proxy">IV.2 Discovery Proxy</a></li>
    <li><a href="13-index-proxying.html#sec:connectivity-proxy">IV.3 Connectivity Proxy</a></li>
    <li><a href="13-index-proxying.html#sec:message-transfer-protocol-mtp-proxy">IV.4 Message Transfer Protocol (MTP) Proxy</a></li>
    <li><a href="13-index-proxying.html#sec:usp-to-non-usp-proxy">IV.5 USP to Non-USP Proxy</a></li>
  </ul>
  <li><a href="14-index-iot-data-model-theory-of-operation.html#sec:iot-data-model-theory-of-operation">Appendix V: IoT Data Model Theory of Operation</a></li>
  <ul>
    <li><a href="14-index-iot-data-model-theory-of-operation.html#sec:introduction-2">V.1 Introduction</a></li>
    <li><a href="14-index-iot-data-model-theory-of-operation.html#sec:iot-data-model-overview">V.2 IoT data model overview</a></li>
    <li><a href="14-index-iot-data-model-theory-of-operation.html#sec:architecture-mappings">V.3 Architecture mappings</a></li>
    <li><a href="14-index-iot-data-model-theory-of-operation.html#sec:iot-data-model-object-details">V.4 IoT data model Object details</a></li>
    <li><a href="14-index-iot-data-model-theory-of-operation.html#sec:examples">V.5 Examples</a></li>
  </ul>
  <li><a href="99-index-footnotes.html#footnotes">Footnotes</a></li>
</ul>
</nav>

    <header id="title-block-header">
      <h1 class="title" id="sec:mtp">4 Message Transfer Protocols<a href="#sec:mtp" class="headerlink" title="Permalink to this header"> <img src="permalink.png" style="width: 0.8em"/></a></h1>
    </header>
    <nav id="_TOC" role="doc-toc">
<ul>
<li><a href="#sec:generic-requirements">4.1 Generic Requirements <span><img src="permalink.png" style="width:0.8em" /></span></a></li>
<li><a href="#sec:coap-binding-deprecated">4.2 CoAP Binding (DEPRECATED) <span><img src="permalink.png" style="width:0.8em" /></span></a></li>
<li><a href="#sec:websocket">4.3 WebSocket Binding <span><img src="permalink.png" style="width:0.8em" /></span></a></li>
<li><a href="#sec:stomp-binding">4.4 STOMP Binding <span><img src="permalink.png" style="width:0.8em" /></span></a></li>
<li><a href="#sec:mqtt-binding">4.5 MQTT Binding <span><img src="permalink.png" style="width:0.8em" /></span></a></li>
</ul>
    </nav>
<p>USP messages are sent between Endpoints over one or more Message Transfer Protocols.</p>
<p><em>Note: Message Transfer Protocol was a term adopted to avoid confusion with the term “Transport”, which is often overloaded to include both application layer (e.g. WebSocket) and the actual OSI Transport layer (e.g. TCP). Throughout this document, Message Transfer Protocol (MTP) refers to application layer transport.</em></p>
<h2 id="sec:generic-requirements">4.1 Generic Requirements <a href="04-index-mtp.html#sec:generic-requirements" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h2>
<p>The requirements in this section are common to all MTPs.</p>
<h3 id="sec:supporting-multiple-mtps">4.1.1 Supporting Multiple MTPs <a href="04-index-mtp.html#sec:supporting-multiple-mtps" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>Agents and Controllers may support more than one MTP. When an Agent supports multiple MTPs, the Agent may be configured with Parameters for reaching a particular Controller across more than one MTP. When an Agent needs to send a Notification to such a Controller, the Agent can be designed (or possibly configured) to select a particular MTP, to try sending the Notification to the Controller on all MTPs simultaneously, or to try MTPs sequentially. USP has been designed to allow Endpoints to recognize when they receive a duplicate Message and to discard any duplicates. Endpoints will always send responses on the same MTP where the Message was received.</p>
<h3 id="sec:securing-mtps">4.1.2 Securing MTPs <a href="04-index-mtp.html#sec:securing-mtps" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>This specification places the following requirement for encrypting MTP headers and payloads on USP implementations that are intended to be used in environments where USP Messages will be transported across the Internet:</p>
<p><strong><span id="r-mtp.0">R-MTP.0 <a href="04-index-mtp.html#r-mtp.0" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> – The Message Transfer Protocol MUST use secure transport when USP Messages cross inter-network boundaries.</p>
<p>For example, it may not be necessary to use MTP layer security when within an end-user’s local area network (LAN). It is necessary to secure transport to and from the Internet, however. If the device implementer can reasonably expect Messages to be transported across the Internet when the device is deployed, then the implementer needs to ensure the device supports encryption of all MTP protocols.</p>
<p>MTPs that operate over UDP will be expected to implement, at least, DTLS 1.2 as defined in <span class="cite" data-citation-ids="RFC6347"><a href="01-index-introduction.html#ref-RFC6347">[22]</a></span>.</p>
<p>MTPs that operate over TCP will be expected to implement, at least, TLS 1.2 as defined in <span class="cite" data-citation-ids="RFC5246"><a href="01-index-introduction.html#ref-RFC5246">[17]</a></span>.</p>
<p>Specific requirements for implementing these are provided in the individual MTP sections.</p>
<p><strong><span id="r-mtp.1">R-MTP.1 <a href="04-index-mtp.html#r-mtp.1" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> – When TLS or DTLS is used to secure an MTP, an Agent MUST require the MTP peer to provide an X.509 certificate.</p>
<p><strong><span id="r-mtp.2">R-MTP.2 <a href="04-index-mtp.html#r-mtp.2" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An Agent capable of obtaining absolute time SHOULD wait until it has accurate absolute time before establishing TLS or DTLS encryption to secure MTP communication. If an Agent for any reason is unable to obtain absolute time, it can establish TLS or DTLS without waiting for accurate absolute time. If an Agent chooses to establish TLS or DTLS before it has accurate absolute time (or if it does not support absolute time), it MUST ignore those components of the received X.509 certificate that involve absolute time, e.g. not-valid-before and not-valid-after certificate restrictions.</p>
<p><strong><span id="r-mtp.3">R-MTP.3 <a href="04-index-mtp.html#r-mtp.3" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An Agent that has obtained an accurate absolute time MUST validate those components of the received X.509 certificate that involve absolute time.</p>
<p><strong><span id="r-mtp.4">R-MTP.4 <a href="04-index-mtp.html#r-mtp.4" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When an Agent receives an X.509 certificate while establishing TLS or DTLS encryption of the MTP, the Agent MUST execute logic that achieves the same results as in the mandatory decision flow elements (identified with “MUST”) from <a href="04-index-mtp.html#fig:receiving-a-x509-certificate" class="figure">Figure 2</a>.</p>
<p><strong><span id="r-mtp.4a">R-MTP.4a <a href="04-index-mtp.html#r-mtp.4a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When an Agent receives an X.509 certificate while establishing TLS or DTLS encryption of the MTP, the Agent SHOULD execute logic that achieves the same results as in the optional decision flow elements (identified with “OPT”) from <a href="04-index-mtp.html#fig:receiving-a-x509-certificate" class="figure">Figure 2</a>.</p>
<figure>
<img src="mtp/validate-cert.png" id="fig:receiving-a-x509-certificate" alt="Figure 2: Receiving a X.509 Certificate " /><figcaption aria-hidden="true">Figure 2: Receiving a X.509 Certificate <a href="04-index-mtp.html#fig:receiving-a-x509-certificate" class="headerlink" title="Permalink to this figure"><img src="permalink.png" style="width:0.8em" /></a></figcaption>
</figure>
<p><em>Note: The .local and .home.arpa domains are defined by the IETF as “Special-Use Domains” for use inside any LAN. It is not possible for an external Certificate Authority (CA) to vouch for whether a LAN device “owns” a particular name in one of these domains (inside a particular LAN) and these LAN networks have no internal CA. Therefore, it is not possible to validate FQDNs within these domains. The Internet Assigned Numbers Authority (IANA) maintains a registry of <a href="https://www.iana.org/assignments/special-use-domain-names/special-use-domain-names.xhtml">Special Use Domains</a>.</em></p>
<h3 id="sec:usp-record-encapsulation">4.1.3 USP Record Encapsulation <a href="04-index-mtp.html#sec:usp-record-encapsulation" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>The USP Record Message is defined as the Message Transfer Protocol (MTP) payload, encapsulating a sequence of datagrams that comprise the USP Message as well as providing additional metadata needed for integrity protection, payload protection and delivery of fragmented USP Messages. Additional metadata fields are used to identify the E2E session context, determine the state of the segmentation and reassembly function, acknowledge received datagrams, request retransmissions, and determine the type of encoding and security mechanism used to encode the USP Message.</p>
<p>Following are the fields contained within a USP Record. When not explicitly set or included in the Record, the fields have a default value based on the type of field. For strings, the default value is an empty byte string. For numbers (uint64) and enumerations, the default value is 0. For repeated bytes, the default value is an empty byte string. The term “Optional” means it is not necessary to include the field in a sent Record. The receiving Endpoint will use default values for fields not included in a received Record. “Required” fields are always included. A Record without a “Required” field will fail to be processed by a receiving Endpoint. “Repeated” fields can be included any number of times, including zero.</p>
<h4 id="sec:record-definition">4.1.3.1 Record Definition <a href="04-index-mtp.html#sec:record-definition" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p><em>Note: This version of the specification defines Record in <a href="05-index-encoding.html#sec:encoding" class="heading">Protocol Buffers v3</a>. This part of the specification may change to a more generic description (normative and non-normative) if further encodings are specified in future versions.</em></p>
<p><code>string version</code></p>
<p>Required. Version (Major.Minor) of the USP Protocol (i.e., “1.0” or “1.1”).</p>
<p><code>string to_id</code></p>
<p>Required. Receiving/Target USP Endpoint Identifier.</p>
<p><code>string from_id</code></p>
<p>Required. Originating/Source USP Endpoint Identifier.</p>
<p><code>enum PayloadSecurity payload_security</code></p>
<p>Optional. An enumeration of type PayloadSecurity. When the payload is present, this indicates the protocol or mechanism used to secure the payload (if any) of the USP Message. The value of <code>TLS12</code> means TLS 1.2 or later (with backward compatibility to TLS 1.2) will be used to secure the payload (see <a href="06-index-e2e-message-exchange.html#sec:tls-payload-encapsulation" class="heading">TLS Payload Encapsulation</a> for more information).</p>
<p>Valid values are:</p>
<pre><code>PLAINTEXT (0)
TLS12 (1)</code></pre>
<p><code>bytes mac_signature</code></p>
<p>Optional. When integrity protection of non-payload fields is performed, this is the message authentication code or signature used to ensure the integrity of the non-payload fields of the USP Record.</p>
<p><code>bytes sender_cert</code></p>
<p>Optional. The PEM encoded certificate, or certificate chain, of the sending USP Endpoint used to provide the signature in the <code>mac_signature</code> field, when integrity protection is used and the payload security mechanism doesn’t provide the mechanism to generate the <code>mac_signature</code>.</p>
<p><code>oneof record_type</code></p>
<p>Required. This field contains one of the types given below:</p>
<p><code>NoSessionContextRecord no_session_context</code></p>
<p><code>SessionContextRecord session_context</code></p>
<p><code>WebSocketConnectRecord websocket_connect</code></p>
<p><code>MQTTConnectRecord mqtt_connect</code></p>
<p><code>STOMPConnectRecord stomp_connect</code></p>
<p><code>DisconnectRecord disconnect</code></p>
<h5 id="sec:nosessioncontextrecord-fields">4.1.3.1.1 NoSessionContextRecord fields <a href="04-index-mtp.html#sec:nosessioncontextrecord-fields" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h5>
<p>The following describe the fields included if <code>record_type</code> is <code>no_session_context</code>.</p>
<p><code>bytes payload</code></p>
<p>Required. The USP Message.</p>
<h5 id="sec:sessioncontextrecord-fields">4.1.3.1.2 SessionContextRecord fields <a href="04-index-mtp.html#sec:sessioncontextrecord-fields" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h5>
<p>The following describe the fields included if <code>record_type</code> is <code>session_context</code>.</p>
<p><code>uint64 session_id</code></p>
<p>Required. This field is the Session Context identifier.</p>
<p><code>uint64 sequence_id</code></p>
<p>Required. Datagram sequence identifier. Used only for exchange of USP Records with an E2E Session Context. The field is initialized to 1 when starting a new Session Context and incremented after each sent USP Record.</p>
<p><em>Note: Endpoints maintain independent values for received and sent sequence_id for a Session Context, based respectively on the number of received and sent Records.</em></p>
<p><code>uint64 expected_id</code></p>
<p>Required. This field contains the next <code>sequence_id</code> the sender is expecting to receive, which implicitly acknowledges to the recipient all transmitted datagrams less than <code>expected_id</code>. Used only for exchange of USP Records with an E2E Session Context.</p>
<p><code>uint64 retransmit_id</code></p>
<p>Optional. Used to request a USP Record retransmission by a USP Endpoint to request a missing USP Record using the missing USP Record’s anticipated <code>sequence_id</code>. Used only for exchange of USP Records with an E2E Session Context. Will be received as <code>0</code> when no retransmission is requested.</p>
<p><code>enum PayloadSARState payload_sar_state</code></p>
<p>Optional. An enumeration of type PayloadSARState. When payload is present, indicates the segmentation and reassembly state represented by the USP Record. Valid values are:</p>
<pre><code>NONE (0)
BEGIN (1)
INPROCESS (2)
COMPLETE (3)</code></pre>
<p><code>enum PayloadSARState payloadrec_sar_state</code></p>
<p>Optional. An enumeration of type PayloadSARState. When payload segmentation is being performed, indicates the segmentation and reassembly state represented by an instance of the payload datagram. If <code>payload_sar_state</code> = <code>0</code> (or is not included or not set), then <code>payloadrec_sar_state</code> will be <code>0</code> (or not included or not set). Valid values are:</p>
<pre><code>NONE (0)
BEGIN (1)
INPROCESS (2)
COMPLETE (3)</code></pre>
<p><code>repeated bytes payload</code></p>
<p>Optional. This repeated field is a sequence of zero, one, or multiple datagrams. It contains the Message, in either <code>PLAINTEXT</code> or encrypted format. When using <code>TLS12</code> payload security, this contains the encrypted TLS records, either sequentially in a single <code>payload</code> field, or divided into multiple <code>payload</code> fields. When using <code>PLAINTEXT</code> payload security there will be a single <code>payload</code> field for any Message being sent.</p>
<h5 id="sec:websocketconnectrecord-fields">4.1.3.1.3 WebSocketConnectRecord fields <a href="04-index-mtp.html#sec:websocketconnectrecord-fields" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h5>
<p>This Record type has no fields.</p>
<h5 id="sec:mqttconnectrecord-fields">4.1.3.1.4 MQTTConnectRecord fields <a href="04-index-mtp.html#sec:mqttconnectrecord-fields" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h5>
<p>The following describe the fields included if <code>record_type</code> is <code>mqtt_connect</code>.</p>
<p><code>enum MQTTVersion version</code></p>
<p>Required. The MQTT protocol version used by the USP Endpoint to send this Record. Valid values are:</p>
<pre><code>V3_1_1 (0)
V5 (1)</code></pre>
<p><code>string subscribed_topic</code></p>
<p>Required. A MQTT Topic where the USP Endpoint sending this Record can be reached (i.e. a MQTT Topic it is subscribed to).</p>
<h5 id="sec:stompconnectrecord-fields">4.1.3.1.5 STOMPConnectRecord fields <a href="04-index-mtp.html#sec:stompconnectrecord-fields" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h5>
<p>The following describe the fields included if <code>record_type</code> is <code>stomp_connect</code>.</p>
<p><code>enum STOMPVersion version</code></p>
<p>Required. The STOMP protocol version used by the USP Endpoint to send this Record. Valid values are:</p>
<pre><code>V1_2 (0)</code></pre>
<p><code>string subscribed_destination</code></p>
<p>Required. A STOMP Destination where the USP Endpoint sending this Record can be reached (i.e. a STOMP Destination it is subscribed to).</p>
<h5 id="sec:disconnectrecord-fields">4.1.3.1.6 DisconnectRecord fields <a href="04-index-mtp.html#sec:disconnectrecord-fields" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h5>
<p>The following describe the fields included if <code>record_type</code> is <code>disconnect</code>.</p>
<p><code>fixed32 reason_code</code></p>
<p>Optional. A code identifying the reason of the disconnect.</p>
<p><code>string reason</code></p>
<p>Optional. A string describing the reason of the disconnect.</p>
<h3 id="sec:usp-record-errors">4.1.4 USP Record Errors <a href="04-index-mtp.html#sec:usp-record-errors" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>A variety of errors can occur while establishing and during a USP communication flow. In order to signal such problems to the other Endpoint while processing an incoming E2E Session Context Record or a Record containing a Message of the type Request, an Endpoint encountering such a problem can create a USP Record containing a Message of type Error and transmit it over the same MTP and connection which was used when the error was encountered.</p>
<p>For this mechanism to work and to prevent information leakage, the sender causing the problem needs to be able to create a valid USP Record containing a valid source Endpoint ID and a correct destination Endpoint ID. In addition a MTP specific return path needs to be known so the error can be delivered.</p>
<p><strong><span id="r-mtp.5">R-MTP.5 <a href="04-index-mtp.html#r-mtp.5" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A recipient of an erroneous USP Record MUST create a Record with a Message of type Error and deliver it to sender if the source Endpoint ID is valid, the destination Endpoint ID is its own, and a MTP-specific return path is known. If any of those criteria on the erroneous Record are not met or the Record is known to contain a USP Message of types Response or Error, it MUST be ignored.</p>
<p>The following error codes (in the range 7100-7199) are defined to allow the Error to be more specifically indicated. Additional requirements for these error codes are included in the specific MTP definition, where appropriate.</p>
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 31%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="header header">
<th style="text-align: left;">Code</th>
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd odd">
<td style="text-align: left;"><code>7100</code></td>
<td style="text-align: left;">Record could not be parsed</td>
<td style="text-align: left;">This error indicates the received USP Record could not be parsed.</td>
</tr>
<tr class="even even">
<td style="text-align: left;"><code>7101</code></td>
<td style="text-align: left;">Secure session required</td>
<td style="text-align: left;">This error indicates USP layer <a href="06-index-e2e-message-exchange.html#sec:secure-message-exchange" class="heading">Secure Message Exchange</a> is required.</td>
</tr>
<tr class="odd odd">
<td style="text-align: left;"><code>7102</code></td>
<td style="text-align: left;">Secure session not supported</td>
<td style="text-align: left;">This error indicates USP layer <a href="06-index-e2e-message-exchange.html#sec:secure-message-exchange" class="heading">Secure Message Exchange</a> was indicated in the received Record but is not supported by the receiving Endpoint.</td>
</tr>
<tr class="even even">
<td style="text-align: left;"><code>7103</code></td>
<td style="text-align: left;">Segmentation and reassembly not supported</td>
<td style="text-align: left;">This error indicates segmentation and reassembly was indicated in the received Record but is not supported by the receiving Endpoint.</td>
</tr>
<tr class="odd odd">
<td style="text-align: left;"><code>7104</code></td>
<td style="text-align: left;">Invalid Record value</td>
<td style="text-align: left;">This error indicates the value of at least one Record field was invalid.</td>
</tr>
<tr class="even even">
<td style="text-align: left;"><code>7105</code></td>
<td style="text-align: left;">Session Context terminated</td>
<td style="text-align: left;">This error indicates an existing Session Context <a href="06-index-e2e-message-exchange.html#sec:establishing-an-e2e-session-context" class="heading">Establishing an E2E Session Context</a> is being terminated.</td>
</tr>
<tr class="odd odd">
<td style="text-align: left;"><code>7106</code></td>
<td style="text-align: left;">Session Context not allowed</td>
<td style="text-align: left;">This error indicates use of Session Context <a href="06-index-e2e-message-exchange.html#sec:establishing-an-e2e-session-context" class="heading">Establishing an E2E Session Context</a> is not allowed or not supported.</td>
</tr>
</tbody>
</table>
<h3 id="sec:connect-and-disconnect-record-types">4.1.5 Connect and Disconnect Record Types <a href="04-index-mtp.html#sec:connect-and-disconnect-record-types" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>A Connect Record is a subgroup of Record types (<code>record_type</code>), there is one Record type per USP MTP in this subgroup. These Records are used to assert the USP Agent presence and exchange needed information for proper start of communication between Agent and Controller, the presence information is specifically useful when using brokered MTPs.</p>
<p><strong><span id="r-mtp.6">R-MTP.6 <a href="04-index-mtp.html#r-mtp.6" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If a USP Agent has the necessary information to create a Connect Record, it MUST send the associated Connect Record, specific for the MTP in use, after it has successfully established an MTP communications channel to a USP Controller.</p>
<p>The <code>DisconnectRecord</code> is a Record type used by a USP Agent to indicate it wishes to end an on-going communication with a USP Controller. It can be used for presence information, for sending supplemental information about the disconnect event and to force the remote USP Endpoint to purge some cached information about the current session.</p>
<p><strong><span id="r-mtp.7">R-MTP.7 <a href="04-index-mtp.html#r-mtp.7" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - The USP Agent SHOULD send a <code>DisconnectRecord</code> to the USP Controller before disconnecting from an MTP communications channel. Upon receiving a <code>DisconnectRecord</code>, a USP Controller MUST clear all cached information relative to an existing E2E Session Context with that Endpoint, including the information that a previous E2E Session Context was established.</p>
<p>It is not mandatory for a USP Endpoint to close its MTP connection after sending or receiving a <code>DisconnectRecord</code>.</p>
<p><strong><span id="r-mtp.8">R-MTP.8 <a href="04-index-mtp.html#r-mtp.8" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - After sending or receiving a <code>DisconnectRecord</code> and maintaining the underlying MTP communications channel or after establishing a new MTP communications channel, the USP Endpoint MUST send or receive the correct Connect Record type before exchanging any other USP Records.</p>
<p><strong><span id="r-mtp.9">R-MTP.9 <a href="04-index-mtp.html#r-mtp.9" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A <code>DisconnectRecord</code> SHOULD include the <code>reason_code</code> and <code>reason</code> fields with an applicable code from <a href="04-index-mtp.html#sec:usp-record-errors" class="heading">USP Record Errors</a>.</p>
<h2 id="sec:coap-binding-deprecated">4.2 CoAP Binding (DEPRECATED) <a href="04-index-mtp.html#sec:coap-binding-deprecated" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h2>
<p><em>Note: The CoAP MTP was deprecated in USP 1.2. Due to the way it is specified this MTP can only be used in local area networks under narrow conditions. Please see <a href="04-index-mtp.html#sec:websocket" class="heading">Section 4.3</a> for a suitable alternative.</em></p>
<p>The Constrained Application Protocol (CoAP) MTP transfers USP Records between USP Endpoints using the CoAP protocol as defined in RFC 7252 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span>. Messages that are transferred between CoAP clients and servers utilize a request/response messaging interaction based on RESTful architectural principles. The following figure depicts the transfer of the USP Records between USP Endpoints.</p>
<figure>
<img src="mtp/coap/usp-request-response-over-coap.png" id="fig:usp-request-response-over-coap" alt="Figure 3: Example: USP Request/Response over the CoAP MTP " /><figcaption aria-hidden="true">Figure 3: Example: USP Request/Response over the CoAP MTP <a href="04-index-mtp.html#fig:usp-request-response-over-coap" class="headerlink" title="Permalink to this figure"><img src="permalink.png" style="width:0.8em" /></a></figcaption>
</figure>
<p>In this example, a USP Request is encoded within a USP Record and encapsulated within a CoAP request message. When a USP Endpoint receives the CoAP request message the USP Endpoint immediately sends a CoAP response message (with no USP Record) to indicate receipt of the message. A USP Response encoded within a USP Record is encapsulated in a new CoAP request message. When the USP Endpoint receives the USP Response, it sends a CoAP response message that indicates receipt of the message. Therefore, all Endpoints supporting CoAP will implement both CoAP client and server.</p>
<p>As noted in the definition of a USP Request, this USP Record either requests the Agent perform some action (create, update, delete, operate, etc.), requests information about an Agent or one or more Service Elements, or acts as a means to deliver Notifications from the Agent to the Controller. Notifications will only cause a USP Response to be generated if specified in the Notification Request. However, the CoAP response will always be sent.</p>
<h3 id="sec:mapping-usp-endpoints-to-coap-uris">4.2.1 Mapping USP Endpoints to CoAP URIs <a href="04-index-mtp.html#sec:mapping-usp-endpoints-to-coap-uris" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>Section 6 of RFC 7262 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span> discusses the URI schemes for identifying CoAP resources and provides a means of locating the resource. These resources are organized hierarchically and governed by a CoAP server listening for CoAP requests on a given port. USP Endpoints are one type of CoAP resource that is identified and discovered.</p>
<p><strong><span id="r-coap.0">R-COAP.0 <a href="04-index-mtp.html#r-coap.0" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - As the USP Endpoint is a resource governed by a CoAP server, the CoAP server MUST also be identified as defined in section 6 of RFC 7262 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span>.</p>
<p><strong><span id="r-coap.1">R-COAP.1 <a href="04-index-mtp.html#r-coap.1" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A USP Endpoint MUST be represented as a CoAP resource with the following resource attributes:</p>
<ul>
<li>Identifier within the CoAP server (uri-path)</li>
<li>Resource type (rt): “<code>bbf.usp.endpoint</code>”</li>
<li>Interface (if): “<code>bbf.usp.c</code>” for USP Controller or “<code>bbf.usp.a</code>” for USP Agent</li>
</ul>
<p>The identifier within the CoAP server is used to deliver messages to the USP Endpoint. When this identifier is used to deliver messages to the USP Endpoint, this identifier is a uri-path that represents the USP Endpoint.</p>
<p><strong><span id="r-coap.2">R-COAP.2 <a href="04-index-mtp.html#r-coap.2" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A CoAP request message MUST include a Uri-Query option that supplies the CoAP server URI of the Endpoint that is the source of the CoAP request, formatted as <code>?reply-to=&lt;coap or coaps uri&gt;</code>. The coap and coaps URIs are defined in sections 6.1 and 6.2 of RFC 7262 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span>. The URI MUST NOT include any optional queries at the end.</p>
<p><strong><span id="r-coap.2a">R-COAP.2a <a href="04-index-mtp.html#r-coap.2a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When a USP Endpoint receives a CoAP request message it MUST use the reply-to Uri-Query option included in the CoAP request as the CoAP URI for the USP Response (if a response is required by the incoming USP Request).</p>
<p><strong><span id="r-coap.3">R-COAP.3 <a href="04-index-mtp.html#r-coap.3" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When creating DNS-SD records (see <a href="03-index-discovery.html#sec:dns-sd-records" class="heading">DNS-SD Records</a>), an Endpoint MUST set the DNS-SD TXT record “path” attribute equal to the value of the CoAP server identifier (uri-path).</p>
<h3 id="sec:mapping-usp-records-to-coap-messages">4.2.2 Mapping USP Records to CoAP Messages <a href="04-index-mtp.html#sec:mapping-usp-records-to-coap-messages" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p><strong><span id="r-coap.4">R-COAP.4 <a href="04-index-mtp.html#r-coap.4" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - In order for USP Records to be transferred between a USP Controller and Agent using CoAP, the USP Record MUST be encapsulated within the CoAP message as defined in RFC 7262 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span>.</p>
<p><strong><span id="r-coap.5">R-COAP.5 <a href="04-index-mtp.html#r-coap.5" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> – USP Records that exceed the CoAP message size MUST be block encapsulated in accordance with <span class="cite" data-citation-ids="RFC7959"><a href="01-index-introduction.html#ref-RFC7959">[31]</a></span>.</p>
<p>USP Records are transferred using the CoAP resource that represents the receiving USP Endpoint using the CoAP POST method as defined in RFC 7252.</p>
<p><strong><span id="r-coap.6">R-COAP.6 <a href="04-index-mtp.html#r-coap.6" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - The CoAP Content-Format for USP Records MUST be application/octet-stream (ID=42) for <a href="05-index-encoding.html#sec:encoding" class="heading">Message Encoding</a>.</p>
<p><strong><span id="r-coap.7">R-COAP.7 <a href="04-index-mtp.html#r-coap.7" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - Upon successful reception of the CoAP message using POST, the CoAP server MUST respond with a response code of <code>2.04 (Changed)</code>.</p>
<h4 id="sec:handling-coap-request-failures">4.2.2.1 Handling CoAP Request Failures <a href="04-index-mtp.html#sec:handling-coap-request-failures" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p>At times CoAP requests fail to complete due to problems in the underlying transport (e.g., timeout) or a failure response code received from the CoAP server due to problems in the CoAP request sent by the CoAP client (4.xx) or problems with the CoAP server implementation (5.xx).</p>
<p><strong><span id="r-coap.8">R-COAP.8 <a href="04-index-mtp.html#r-coap.8" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - CoAP clients and servers MUST implement the required CoAP response codes defined in section 5.9 of RFC 7262 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span>.</p>
<p><strong><span id="r-coap.9">R-COAP.9 <a href="04-index-mtp.html#r-coap.9" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When a CoAP client receives a failure indication (e.g., timeout) from the underlying transport layer, the CoAP client MUST indicate a timeout to the USP Endpoint.</p>
<p><strong><span id="r-coap.10">R-COAP.10 <a href="04-index-mtp.html#r-coap.10" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When a CoAP client receives a response code of 4.xx or 5.xx, the CoAP client MUST indicate a CoAP failure to the USP Endpoint.</p>
<p>When a CoAP client sends a CoAP request, the CoAP client can provide incorrect or missing information in the CoAP request. For example, a CoAP client can send a CoAP request with an:</p>
<ul>
<li>Invalid CoAP method: The CoAP server responds with a <code>4.05</code></li>
<li>Invalid Content-Format options: The CoAP server responds with a <code>4.15</code></li>
<li>Invalid or not understandable payload: The CoAP server responds with a <code>4.00</code></li>
</ul>
<p><strong><span id="r-coap.11">R-COAP.11 <a href="04-index-mtp.html#r-coap.11" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When a CoAP server receives a CoAP request with an invalid CoAP method, the CoAP server MUST respond with a <code>4.05</code> response code.</p>
<p><strong><span id="r-coap.12">R-COAP.12 <a href="04-index-mtp.html#r-coap.12" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When a CoAP server receives a CoAP request with an invalid CoAP Content-Format option, the CoAP server MUST respond with a <code>4.15</code> response code.</p>
<p><strong><span id="r-coap.13">R-COAP.13 <a href="04-index-mtp.html#r-coap.13" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When a CoAP server receives a CoAP request and the receiving USP Endpoint cannot interpret or decode the USP Record for processing, the CoAP server MUST respond with a <code>4.00</code> response code.</p>
<h3 id="sec:mtp-message-encryption">4.2.3 MTP Message Encryption <a href="04-index-mtp.html#sec:mtp-message-encryption" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>CoAP MTP message encryption is provided using DTLS as described in Section 9 of RFC 7262 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span>.</p>
<p>In section 9 of RFC 7262 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span>, CoAP messages are secured using one of three modes:</p>
<ul>
<li>NoSec: DTLS is disabled</li>
<li>PreSharedKey: DTLS is enabled and the MTP endpoint uses pre-shared keys that are used to validate the identity of CoAP endpoints involved in the message exchange</li>
<li>RawPublicKey: DTLS is enabled and the MTP endpoint has an asymmetric key pair without a certificate. The MTP endpoint has an identity calculated from the public key and a list of other MTP endpoints to which it can communicate</li>
<li>Certificate: DTLS is enabled and the MTP endpoint has an asymmetric key pair with an X.509 certificate.</li>
</ul>
<p><strong><span id="r-coap.14">R-COAP.14 <a href="04-index-mtp.html#r-coap.14" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - CoAP clients and servers MUST implement the NoSec and Certificate modes of CoAP security as defined in RFC 7262 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span>.</p>
<p>While section 9 of RFC 7262 <span class="cite" data-citation-ids="RFC7252"><a href="01-index-introduction.html#ref-RFC7252">[29]</a></span> provides guidance on securing CoAP, further guidance related to DTLS implementations for the Internet of Things is provided by RFC 7925 <span class="cite" data-citation-ids="RFC7925"><a href="01-index-introduction.html#ref-RFC7925">[30]</a></span>.</p>
<p><strong><span id="r-coap.15">R-COAP.15 <a href="04-index-mtp.html#r-coap.15" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - CoAP clients and servers MUST implement the mandatory statements of RFC 7925 <span class="cite" data-citation-ids="RFC7925"><a href="01-index-introduction.html#ref-RFC7925">[30]</a></span> with the exception that:</p>
<ul>
<li>Section 4.4.1 USP Controller certificates can contain domain names with wildcard characters per RFC 6125 <span class="cite" data-citation-ids="RFC6125"><a href="01-index-introduction.html#ref-RFC6125">[21]</a></span> guidance.</li>
<li>Section 4.4.2 Client certificate identifiers do not use EUI-64 identifier but instead use the identifier defined for Client certificates in this Working Text.</li>
<li>Section 4.4.5 Client Certificate URLs are not required to be implemented.</li>
</ul>
<p>As USP Endpoints play the role of both CoAP client and server; when the MTP is secured using the Certificate mode of CoAP Security, the USP Endpoint provides a X.509 certificate to the MTP peer.</p>
<p><strong><span id="r-coap.16">R-COAP.16 <a href="04-index-mtp.html#r-coap.16" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> – When the Certificate mode of CoAP is used to secure an MTP, a USP Endpoint MUST provide an X.509 certificate to the MTP peer.</p>
<p>Note that DTLS sessions established for an Endpoint’s CoAP client and CoAP server are distinct. Therefore, it is possible for CoAP to be encrypted in one direction and not the other. If this happens, the requirements and flows in <a href="08-index-auth.html#sec:auth" class="heading">Authentication and Authorization</a> will dictate that <a href="06-index-e2e-message-exchange.html#sec:secure-message-exchange" class="heading">Secure Message Exchange</a> be used.</p>
<h2 id="sec:websocket">4.3 WebSocket Binding <a href="04-index-mtp.html#sec:websocket" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h2>
<p>The WebSockets MTP transfers USP Records between USP Endpoints using the WebSocket protocol as defined in RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>. Messages that are transferred between WebSocket clients and servers utilize a request/response messaging interaction across an established WebSocket session.</p>
<h3 id="sec:mapping-usp-endpoints-to-websocket-uris">4.3.1 Mapping USP Endpoints to WebSocket URIs <a href="04-index-mtp.html#sec:mapping-usp-endpoints-to-websocket-uris" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>Section 3 of RFC 6455 discusses the URI schemes for identifying WebSocket origin servers and their target resources. These resources are organized hierarchically and governed by a WebSocket origin server listening for WebSocket messages on a given port. USP Endpoints are one type of WebSocket resource that is identified and discovered.</p>
<p><strong><span id="r-ws.1">R-WS.1 <a href="04-index-mtp.html#r-ws.1" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - As the USP Endpoint is a resource governed by a WebSocket origin server, the WebSocket server MUST also be identified as defined in section 3 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<p><strong><span id="r-ws.2">R-WS.2 <a href="04-index-mtp.html#r-ws.2" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A USP Endpoint MUST be represented as a WebSocket resource using the path component as defined in section 3 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<p><strong><span id="r-ws.3">R-WS.3 <a href="04-index-mtp.html#r-ws.3" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When creating DNS-SD records (see <a href="03-index-discovery.html#sec:discovery" class="heading">Discovery</a>), an Endpoint MUST set the DNS-SD TXT record “path” attribute equal to the value of the Websocket resource using the path component as defined in section 3 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<h3 id="sec:handling-of-the-websocket-session">4.3.2 Handling of the WebSocket Session <a href="04-index-mtp.html#sec:handling-of-the-websocket-session" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>When exchanging the USP Records across WebSockets MTPs, the two USP Endpoints establish a WebSocket session. These WebSocket sessions are expected to be long lived and are reused for subsequent USP Record exchange. A WebSocket session is established using a handshake procedure described in section 4 of RFC 6455. When a WebSocket connection is not longer necessary, the WebSocket connection is closed according to section 7 of RFC 6455. The following figure depicts a WebSocket session handshake that is originated by an Agent.</p>
<figure>
<img src="mtp/websocket/websocket-session-handshake.png" id="fig:websocket-session-handshake" alt="Figure 4: WebSocket Session Handshake " /><figcaption aria-hidden="true">Figure 4: WebSocket Session Handshake <a href="04-index-mtp.html#fig:websocket-session-handshake" class="headerlink" title="Permalink to this figure"><img src="permalink.png" style="width:0.8em" /></a></figcaption>
</figure>
<p>While WebSocket sessions can be established by either USP Controllers or USP Agents in many deployment scenarios (e.g. communication between USP Endpoints across the Internet), in general, USP Agents will establish the WebSocket session and not expose an open port toward the Internet for security reasons. Regardless of which entity establishes the WebSocket session, at most one (1) open WebSocket session is utilized between the USP Endpoints.</p>
<p><strong><span id="r-ws.4">R-WS.4 <a href="04-index-mtp.html#r-ws.4" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints that exchange USP Records MUST utilize at most one (1) open WebSocket session.</p>
<p><strong><span id="r-ws.5">R-WS.5 <a href="04-index-mtp.html#r-ws.5" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agent MUST provide the capability to originate the establishment of a WebSocket session.</p>
<p><strong><span id="r-ws.6">R-WS.6 <a href="04-index-mtp.html#r-ws.6" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agent MUST provide the capability to accept the establishment of a WebSocket session from a USP Controller.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-ws.6" class="requirement">R-WS.6</a> was altered from a MAY to a MUST in USP 1.2 to ensure that the WebSocket MTP is suitable for the in-home communications use case.</em></p>
<p><strong><span id="r-ws.7">R-WS.7 <a href="04-index-mtp.html#r-ws.7" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A USP Endpoint MUST implement the WebSocket handshake protocol to establish a WebSocket connection as defined in section 4 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<p><strong><span id="r-ws.8">R-WS.8 <a href="04-index-mtp.html#r-ws.8" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A USP Endpoint MUST implement the procedures to close a WebSocket connection as defined in section 7 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<h4 id="sec:mapping-usp-records-to-websocket-messages">4.3.2.1 Mapping USP Records to WebSocket Messages <a href="04-index-mtp.html#sec:mapping-usp-records-to-websocket-messages" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p>During the establishment of the WebSocket session, the WebSocket client informs the WebSocket server in the <code>Sec-WebSocket-Protocol</code> header about the type of USP Records that will be exchanged across the established WebSocket connection. For USP Records, the <code>Sec-WebSocket-Protocol</code> header contains the value <code>v1.usp</code>. When presented with a <code>Sec-WebSocket-Protocol</code> header containing <code>v1.usp</code>, the WebSocket Server serving a USP Endpoint returns <code>v1.usp</code> in the response’s Sec-WebSocket-Protocol header. If the WebSocket client doesn’t receive a <code>Sec-WebSocket-Protocol</code> header with a value of <code>v1.usp</code>, the WebSocket client does not establish the WebSocket session.</p>
<p>When a WebSocket connection is being initiated with TLS, no USP Record is sent until the TLS negotiation is complete. The WebSocket server will be unable to identify the Endpoint ID of the client unless it looks inside the certificate. To make it easier for the server to identify the client, the WebSocket Extension <code>bbf-usp-protocol</code> has been registered. The extension parameter of <code>eid</code> is defined for use with this extension. The value of the <code>eid</code> parameter will be the Endpoint ID of the Endpoint sending the WebSocket header.</p>
<p><em>Note: When using an Endpoint ID as the value of the <code>eid</code> parameter in the <code>Sec-WebSocket-Extensions</code> header, it will need to be in the <code>quoted-string</code> form as referenced in section 9 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</em></p>
<p><strong><span id="r-ws.9">R-WS.9 <a href="04-index-mtp.html#r-ws.9" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - The WebSocket’s handshake <code>Sec-WebSocket-Protocol</code> header for exchange of USP Records using the protocol-buffers encoding mechanism MUST be <code>v1.usp</code>.</p>
<p><strong><span id="r-ws.10">R-WS.10 <a href="04-index-mtp.html#r-ws.10" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A WebSocket client MUST include the <code>Sec-WebSocket-Protocol</code> header for exchange of USP Records when initiating a WebSocket session.</p>
<p><strong><span id="r-ws.10a">R-WS.10a <a href="04-index-mtp.html#r-ws.10a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A WebSocket client MUST include the <code>Sec-WebSocket-Extensions</code> header with <code>bbf-usp-protocol</code> WebSocket Extension and extension parameter <code>eid</code> equal to the client’s Endpoint ID when initiating a WebSocket session.</p>
<p><strong><span id="r-ws.11">R-WS.11 <a href="04-index-mtp.html#r-ws.11" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A WebSocket server that supports USP Endpoints MUST include the <code>Sec-WebSocket-Protocol</code> header for exchange of USP Records when responding to an initiation of a WebSocket session.</p>
<p><strong><span id="r-ws.11a">R-WS.11a <a href="04-index-mtp.html#r-ws.11a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A WebSocket server MUST include the <code>Sec-WebSocket-Extensions</code> header with <code>bbf-usp-protocol</code> WebSocket Extension and extension parameter <code>eid</code> equal to the server’s Endpoint ID when responding to an initiation of a WebSocket session that includes the <code>bbf-usp-protocol</code> extension.</p>
<p><strong><span id="r-ws.11b">R-WS.11b <a href="04-index-mtp.html#r-ws.11b" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - WebSocket clients SHOULD NOT consider WebSocket responses that do not include the <code>bbf-usp-protocol</code> WebSocket Extension to be an error.</p>
<p><strong><span id="r-ws.11c">R-WS.11c <a href="04-index-mtp.html#r-ws.11c" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - WebSocket servers SHOULD NOT consider WebSocket session initiation requests that do not include the <code>bbf-usp-protocol</code> WebSocket Extension to be an error.</p>
<p><strong><span id="r-ws.12">R-WS.12 <a href="04-index-mtp.html#r-ws.12" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A WebSocket client MUST NOT establish a WebSocket session if the response to a WebSocket session initiation request does not include the <code>Sec-WebSocket-Protocol</code> header for exchange of USP Records in response to an initiation of a WebSocket session.</p>
<p><strong><span id="r-ws.12a">R-WS.12a <a href="04-index-mtp.html#r-ws.12a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A WebSocket server MUST NOT establish a WebSocket session if the WebSocket session initiation request does not include the <code>Sec-WebSocket-Protocol</code> header.</p>
<h3 id="sec:handling-of-websocket-frames">4.3.3 Handling of WebSocket Frames <a href="04-index-mtp.html#sec:handling-of-websocket-frames" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>RFC 6455 defines a number of type of WebSocket control frames (e.g., Ping, Pong, Close) and associated condition codes in order to maintain a WebSocket connection. In addition messages are transferred in WebSocket Data control frame.</p>
<p><strong><span id="r-ws.13">R-WS.13 <a href="04-index-mtp.html#r-ws.13" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A USP Endpoint MUST implement the WebSocket control frames defined in section 5.5 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<p>USP Records can be transferred between USP Controllers and USP Agents over an established WebSocket session. These USP Records are encapsulated within a binary WebSocket data frame as depicted by the figure below.</p>
<figure>
<img src="mtp/websocket/USP-request-over-websocket.png" id="fig:usp-request-using-a-websocket-session" alt="Figure 5: USP Request using a WebSocket Session " /><figcaption aria-hidden="true">Figure 5: USP Request using a WebSocket Session <a href="04-index-mtp.html#fig:usp-request-using-a-websocket-session" class="headerlink" title="Permalink to this figure"><img src="permalink.png" style="width:0.8em" /></a></figcaption>
</figure>
<p><strong><span id="r-ws.14">R-WS.14 <a href="04-index-mtp.html#r-ws.14" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - In order for USP Records to be transferred between a USP Controller and Agent using WebSockets MUST be encapsulated within as a binary WebSocket data frame as defined in section 5.6 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<p><strong><span id="r-ws.15">R-WS.15 <a href="04-index-mtp.html#r-ws.15" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Records are transferred between USP Endpoints using message body procedures as defined in section 6 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<h4 id="sec:handling-failures-to-deliver-usp-records">4.3.3.1 Handling Failures to Deliver USP Records <a href="04-index-mtp.html#sec:handling-failures-to-deliver-usp-records" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p>If a USP Endpoint receives a WebSocket frame containing a USP Record that cannot be extracted for processing (e.g., text frame instead of a binary frame, malformed USP Record or USP Record, bad encoding), the receiving USP Endpoint notifies the originating USP Endpoint that an error occurred by closing the WebSocket connection with a <code>1003</code> Status Code with the WebSocket Close frame.</p>
<p><strong><span id="r-ws.16">R-WS.16 <a href="04-index-mtp.html#r-ws.16" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A USP Endpoint that receives a WebSocket frame containing a USP Record that cannot be extracted for processing, the receiving USP Endpoint MUST terminate the connection using a WebSocket Close frame with a Status Code of <code>1003</code>.</p>
<h4 id="sec:keeping-the-websocket-session-alive">4.3.3.2 Keeping the WebSocket Session Alive <a href="04-index-mtp.html#sec:keeping-the-websocket-session-alive" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p>Once a WebSocket session is established, the WebSocket session is expected to remain open for future exchanges of USP Records. The WebSocket protocol uses Ping and Pong control frames as a keep-alive session. Section 5.5 of RFC 6455 discusses the handling of Ping and Pong control frames.</p>
<p><strong><span id="r-ws.17">R-WS.17 <a href="04-index-mtp.html#r-ws.17" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A USP Agent MUST implement a WebSocket keep-alive mechanism by periodically sending Ping control frames and responding to received Ping control frames with Pong control frames as described in section 5.5 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<p><strong><span id="r-ws.18">R-WS.18 <a href="04-index-mtp.html#r-ws.18" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A USP Agent MUST provide the capability to assign a keep-alive interval in order to send Ping control frames to the remote USP Endpoint.</p>
<h4 id="sec:websocket-session-retry">4.3.3.3 WebSocket Session Retry <a href="04-index-mtp.html#sec:websocket-session-retry" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p>If for any reason a WebSocket Session is closed, the USP Endpoint will attempt to re-establish the WebSocket Session according to its session retry policy. For Controllers, this session retry policy is implementation specific.</p>
<p><strong><span id="r-ws.19">R-WS.19 <a href="04-index-mtp.html#r-ws.19" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> – When retrying to establish a WebSocket Session, the Agent MUST use the following retry algorithm to manage the WebSocket Session establishment procedure:</p>
<p>For Agents, the retry interval range is controlled by two variables (described in the table below): the minimum wait interval and the interval multiplier. The corresponding data model Parameter MAY be implemented to allow a USP Controller to change the values of these variables. The factory default values of these variables MUST be the default values listed in the Default column of the table below.</p>
<table style="width:99%;">
<colgroup>
<col style="width: 26%" />
<col style="width: 18%" />
<col style="width: 21%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="header header">
<th style="text-align: right;">Descriptive Name</th>
<th style="text-align: center;">Symbol</th>
<th style="text-align: center;">Default</th>
<th style="text-align: left;">Data Model Parameter Name</th>
</tr>
</thead>
<tbody>
<tr class="odd odd">
<td style="text-align: right;">Minimum wait interval</td>
<td style="text-align: center;">m</td>
<td style="text-align: center;">5 seconds</td>
<td style="text-align: left;"><code>Device.LocalAgent.Controller.{i}.MTP.{i}.WebSocket.SessionRetryMinimumWaitInterval</code></td>
</tr>
<tr class="even even">
<td style="text-align: right;">Interval multiplier</td>
<td style="text-align: center;">k</td>
<td style="text-align: center;">2000</td>
<td style="text-align: left;"><code>Device.LocalAgent.Controller.{i}.MTP.{i}.WebSocket.SessionRetryIntervalMultiplier</code></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 30%" />
<col style="width: 41%" />
</colgroup>
<thead>
<tr class="header header">
<th style="text-align: right;">Retry Count</th>
<th style="text-align: center;">Default Wait Interval Range (min-max seconds)</th>
<th style="text-align: left;">Actual Wait Interval Range (min-max seconds)</th>
</tr>
</thead>
<tbody>
<tr class="odd odd">
<td style="text-align: right;">#1</td>
<td style="text-align: center;">5-10</td>
<td style="text-align: left;">m - m.(k/1000)</td>
</tr>
<tr class="even even">
<td style="text-align: right;">#2</td>
<td style="text-align: center;">10-20</td>
<td style="text-align: left;">m.(k/1000) - m.(k/1000)^2</td>
</tr>
<tr class="odd odd">
<td style="text-align: right;">#3</td>
<td style="text-align: center;">20-40</td>
<td style="text-align: left;">m.(k/1000)^2 - m.(k/1000)^3</td>
</tr>
<tr class="even even">
<td style="text-align: right;">#4</td>
<td style="text-align: center;">40-80</td>
<td style="text-align: left;">m.(k/1000)^3 - m.(k/1000)^4</td>
</tr>
<tr class="odd odd">
<td style="text-align: right;">#5</td>
<td style="text-align: center;">80-160</td>
<td style="text-align: left;">m.(k/1000)^4 - m.(k/1000)^5</td>
</tr>
<tr class="even even">
<td style="text-align: right;">#6</td>
<td style="text-align: center;">160-320</td>
<td style="text-align: left;">m.(k/1000)^5 - m.(k/1000)^6</td>
</tr>
<tr class="odd odd">
<td style="text-align: right;">#7</td>
<td style="text-align: center;">320-640</td>
<td style="text-align: left;">m.(k/1000)^6 - m.(k/1000)^7</td>
</tr>
<tr class="even even">
<td style="text-align: right;">#8</td>
<td style="text-align: center;">640-1280</td>
<td style="text-align: left;">m.(k/1000)^7 - m.(k/1000)^8</td>
</tr>
<tr class="odd odd">
<td style="text-align: right;">#9</td>
<td style="text-align: center;">1280-2560</td>
<td style="text-align: left;">m.(k/1000)^8 - m.(k/1000)^9</td>
</tr>
<tr class="even even">
<td style="text-align: right;">#10 and subsequent</td>
<td style="text-align: center;">2560-5120</td>
<td style="text-align: left;">m.(k/1000)^9 - m.(k/1000)^10</td>
</tr>
</tbody>
</table>
<p><strong><span id="r-ws.20">R-WS.20 <a href="04-index-mtp.html#r-ws.20" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> – Once a WebSocket session is established between the Agent and the Controller, the Agent MUST reset the WebSocket MTP’s retry count to zero for the next WebSocket Session establishment.</p>
<p><strong><span id="r-ws.21">R-WS.21 <a href="04-index-mtp.html#r-ws.21" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> – If a reboot of the Agent occurs, the Agent MUST reset the WebSocket MTP’s retry count to zero for the next WebSocket Session establishment.</p>
<h3 id="sec:mtp-message-encryption-1">4.3.4 MTP Message Encryption <a href="04-index-mtp.html#sec:mtp-message-encryption-1" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>WebSocket MTP message encryption is provided using certificates in TLS as described in section 10.5 and section 10.6 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<p><strong><span id="r-ws.22">R-WS.22 <a href="04-index-mtp.html#r-ws.22" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing WebSockets clients and servers for message transport MUST implement the Certificate modes of TLS security as defined in sections 10.5 and 10.6 of RFC 6455 <span class="cite" data-citation-ids="RFC6455"><a href="01-index-introduction.html#ref-RFC6455">[23]</a></span>.</p>
<p><strong><span id="r-ws.23">R-WS.23 <a href="04-index-mtp.html#r-ws.23" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints capable of obtaining absolute time SHOULD wait until it has accurate absolute time before contacting the peer USP Endpoint. If a USP Endpoint for any reason is unable to obtain absolute time, it can contact the peer USP Endpoint without waiting for accurate absolute time. If a USP Endpoint chooses to contact the peer USP Endpoint before it has accurate absolute time (or if it does not support absolute time), it MUST ignore those components of the peer USP Endpoint’s WebScoket MTP certificate that involve absolute time, e.g. not-valid-before and not-valid-after certificate restrictions.</p>
<p><strong><span id="r-ws.24">R-WS.24 <a href="04-index-mtp.html#r-ws.24" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Controller certificates MAY contain domain names with wildcard characters per RFC 6125 <span class="cite" data-citation-ids="RFC6125"><a href="01-index-introduction.html#ref-RFC6125">[21]</a></span> guidance.</p>
<h2 id="sec:stomp-binding">4.4 STOMP Binding <a href="04-index-mtp.html#sec:stomp-binding" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h2>
<p>The STOMP MTP transfers USP Records between USP endpoints using version 1.2 of the STOMP protocol <span class="cite" data-citation-ids="STOMP-1-2"><a href="01-index-introduction.html#ref-STOMP-1-2">[35]</a></span>, further referred to as “STOMP Specification”, or the Simple Text Oriented Message Protocol. Messages that are transferred between STOMP clients utilize a message bus interaction model where the STOMP server is the messaging broker that routes and delivers messages based on the destination included in the STOMP header.</p>
<p>The following figure depicts the transfer of the USP Records between USP Agents and Controllers.</p>
<figure>
<img src="mtp/stomp/STOMP-architecture.jpg" id="fig:usp-over-stomp" alt="Figure 6: USP over STOMP Architecture " /><figcaption aria-hidden="true">Figure 6: USP over STOMP Architecture <a href="04-index-mtp.html#fig:usp-over-stomp" class="headerlink" title="Permalink to this figure"><img src="permalink.png" style="width:0.8em" /></a></figcaption>
</figure>
<p>The basic steps for any USP Endpoint that utilizes a STOMP MTP are:</p>
<ol>
<li>Negotiate TLS (if required/configured)</li>
<li>Connect to the STOMP Server</li>
<li>Maintain Heart Beats (if configured)</li>
<li>Subscribe to a Destination</li>
<li>Send USP Records</li>
</ol>
<p><strong><span id="r-stomp.0">R-STOMP.0 <a href="04-index-mtp.html#r-stomp.0" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents utilizing STOMP clients for message transport MUST support the <code>STOMPConn:1</code> and <code>STOMPController:1</code> data model profiles.</p>
<p><strong><span id="r-stomp.1">R-STOMP.1 <a href="04-index-mtp.html#r-stomp.1" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents utilizing STOMP clients for message transport SHOULD support the <code>STOMPAgent:1</code> and <code>STOMPHeartbeat:1</code> data model profile.</p>
<h3 id="sec:handling-of-the-stomp-session">4.4.1 Handling of the STOMP Session <a href="04-index-mtp.html#sec:handling-of-the-stomp-session" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>When exchanging USP Records across STOMP MTPs, each USP Endpoint establishes a communications session with a STOMP server. These STOMP communications sessions are expected to be long lived and are reused for subsequent exchange of USP Records. A STOMP communications session is established using a handshake procedure as described in “Connecting a USP Endpoint to the STOMP Server” section below. A STOMP communications session is intended to be established as soon as the USP Endpoint becomes network-aware and is capable of sending TCP/IP messages.</p>
<p>When a STOMP communications session is no longer necessary, the STOMP connection is closed by the STOMP client, preferably by sending a <code>DISCONNECT</code> frame (see “Handling Other STOMP Frames” section below).</p>
<h4 id="sec:connecting-a-usp-endpoint-to-the-stomp-server">4.4.1.1 Connecting a USP Endpoint to the STOMP Server <a href="04-index-mtp.html#sec:connecting-a-usp-endpoint-to-the-stomp-server" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p><strong><span id="r-stomp.2">R-STOMP.2 <a href="04-index-mtp.html#r-stomp.2" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing STOMP clients for message transport MUST send a <code>STOMP</code> frame to the STOMP server to initiate the STOMP communications session as defined in the “Connecting” section of the STOMP Specification.</p>
<p><strong><span id="r-stomp.3">R-STOMP.3 <a href="04-index-mtp.html#r-stomp.3" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints that DO NOT utilize client certificate authentication MUST include the login and passcode STOMP headers in the STOMP frame. For a USP Agent, if the <code>.STOMP.Connection.{i}.Username</code> Parameter is implemented then its value will be the source for the <code>login</code> STOMP header, and if the <code>.STOMP.Connection.{i}.Password</code> Parameter is implemented then its value will be the source for the <code>passcode</code> STOMP header.</p>
<p><strong><span id="r-stomp.4">R-STOMP.4 <a href="04-index-mtp.html#r-stomp.4" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints sending a <code>STOMP</code> frame MUST include (in addition to other mandatory STOMP headers) an <code>endpoint-id</code> STOMP header containing the Endpoint ID of the USP Endpoint sending the frame. <em>Note: According to the STOMP Specification, the <code>STOMP</code> frame requires that “C style literal escapes” need to be used to encode any carriage return, line feed, or colon characters that are found within the UTF-8 encoded headers, and <a href="04-index-mtp.html#r-stomp.4" class="requirement">R-STOMP.4</a> requires the Endpoint ID to be included in those headers. Since the Endpoint ID always contains colon characters, those will need to be escaped.</em></p>
<p><strong><span id="r-stomp.5">R-STOMP.5 <a href="04-index-mtp.html#r-stomp.5" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints sending a STOMP frame MUST include a host STOMP header, if configured to do so. For a USP Agent the value MUST contain the value from the appropriate <code>.STOMP.Connection.{i}.VirtualHost</code> Parameter if supported and not empty.</p>
<p><strong><span id="r-stomp.6">R-STOMP.6 <a href="04-index-mtp.html#r-stomp.6" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If the USP Endpoint receives a <code>subscribe-dest</code> STOMP header in the <code>CONNECTED</code> frame, it MUST use the associated value when Subscribing to its destination (see “Subscribing a USP Endpoint to a STOMP Destination” section for more details).</p>
<p><strong><span id="r-stomp.7">R-STOMP.7 <a href="04-index-mtp.html#r-stomp.7" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If the connection to the STOMP server is NOT successful then the USP Endpoint MUST enter a connection retry state. For a USP Agent the retry mechanism is based on the <code>STOMP.Connection.{i}.</code> retry Parameters: <code>ServerRetryInitialInterval</code>, <code>ServerRetryIntervalMultiplier</code>, and <code>ServerRetryMaxInterval</code>.</p>
<h4 id="sec:handling-the-stomp-heart-beat-mechanism">4.4.1.2 Handling the STOMP Heart Beat Mechanism <a href="04-index-mtp.html#sec:handling-the-stomp-heart-beat-mechanism" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p>The STOMP Heart Beat mechanism can be used to periodically send data between a STOMP client and a STOMP server to ensure that the underlying TCP connection is still available. This is an optional STOMP mechanism and is negotiated when establishing the STOMP connection.</p>
<p><strong><span id="r-stomp.8">R-STOMP.8 <a href="04-index-mtp.html#r-stomp.8" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If the <code>STOMP.Connection</code> instance’s <code>EnableHeartbeats</code> Parameter value is true then the USP Agent MUST negotiate the STOMP Heart Beat mechanism within the <code>STOMP</code> frame during the process of establishing the STOMP connection as is defined in the “Heart-beating” section of the STOMP Specification.</p>
<p><strong><span id="r-stomp.9">R-STOMP.9 <a href="04-index-mtp.html#r-stomp.9" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If the <code>STOMP.Connection</code> instance’s <code>EnableHeartbeats</code> Parameter value is either false or not implemented then the USP Agent MUST either not send the <code>heart-beat</code> STOMP header in the <code>STOMP</code> frame or send “0,0” as the value of the <code>heart-beat</code> STOMP header in the <code>STOMP</code> frame.</p>
<p><strong><span id="r-stomp.10">R-STOMP.10 <a href="04-index-mtp.html#r-stomp.10" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents negotiating the STOMP Heart Beat mechanism MUST use the <code>STOMP.Connection.{i}.OutgoingHeartbeat</code> and <code>STOMP.Connection.{i}.IncomingHeartbeat</code> Parameter values within the <code>heart-beat</code> STOMP header as defined in the “Heart-beating” section of the STOMP Specification.</p>
<p><strong><span id="r-stomp.11">R-STOMP.11 <a href="04-index-mtp.html#r-stomp.11" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents that have negotiated a STOMP Heart Beat mechanism with a STOMP server MUST adhere to the heart beat values (as defined in the “Heart-beating” section of the STOMP Specification) as returned in the <code>CONNECTED</code> frame.</p>
<h3 id="sec:mapping-usp-endpoints-to-stomp-destinations">4.4.2 Mapping USP Endpoints to STOMP Destinations <a href="04-index-mtp.html#sec:mapping-usp-endpoints-to-stomp-destinations" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>USP Agents will have one STOMP destination per STOMP MTP independent of whether those STOMP MTPs use the same <code>STOMP.Connection</code> instance or a different one. The STOMP destination is either configured by the STOMP server via the USP custom <code>subscribe-dest</code> STOMP Header received in the <code>CONNECTED</code> frame (exposed in the <code>Device.LocalAgent.MTP.{i}.STOMP.DestinationFromServer</code> Parameter) or taken from the <code>Device.LocalAgent.MTP.{i}.STOMP.Destination</code> Parameter if there wasn’t a <code>subscribe-dest</code> STOMP Header received in the <code>CONNECTED</code> frame. The USP custom <code>subscribe-dest</code> STOMP Header is helpful in scenarios where the USP Agent doesn’t have a pre-configured destination as it allows the USP Agent to discover the destination.</p>
<p>A USP Controller will subscribe to a STOMP destination for each STOMP server that it is associated with. The USP Controller’s STOMP destination needs to be known by the USP Agent (this is configured in the <code>Device.LocalAgent.Controller.{i}.MTP.{i}.STOMP.Destination</code> Parameter) as it is used when sending a USP Record containing a Notification.</p>
<h4 id="sec:subscribing-a-usp-endpoint-to-a-stomp-destination">4.4.2.1 Subscribing a USP Endpoint to a STOMP Destination <a href="04-index-mtp.html#sec:subscribing-a-usp-endpoint-to-a-stomp-destination" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p><strong><span id="r-stomp.12">R-STOMP.12 <a href="04-index-mtp.html#r-stomp.12" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing STOMP clients for message transport MUST subscribe to their assigned STOMP destination by sending a <code>SUBSCRIBE</code> frame to the STOMP server as defined in the “SUBSCRIBE” section of the STOMP Specification.</p>
<p><strong><span id="r-stomp.13">R-STOMP.13 <a href="04-index-mtp.html#r-stomp.13" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints sending a <code>SUBSCRIBE</code> frame MUST include (in addition to other mandatory STOMP headers) a <code>destination</code> STOMP header containing the STOMP destination associated with the USP Endpoint sending the frame.</p>
<p><strong><span id="r-stomp.14">R-STOMP.14 <a href="04-index-mtp.html#r-stomp.14" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents that receive a <code>subscribe-dest</code> STOMP Header in the <code>CONNECTED</code> frame MUST use that STOMP destination in the <code>destination</code> STOMP header when sending a <code>SUBSCRIBE</code> frame.</p>
<p><strong><span id="r-stomp.15">R-STOMP.15 <a href="04-index-mtp.html#r-stomp.15" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents that have NOT received a <code>subscribe-dest</code> STOMP Header in the <code>CONNECTED</code> frame MUST use the STOMP destination found in the <code>Device.LocalAgent.MTP.{i}.STOMP.Destination</code> Parameter in the <code>destination</code> STOMP header when sending a <code>SUBSCRIBE</code> frame.</p>
<p><strong><span id="r-stomp.16">R-STOMP.16 <a href="04-index-mtp.html#r-stomp.16" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents that have NOT received a <code>subscribe-dest</code> STOMP Header in the <code>CONNECTED</code> frame and do NOT have a value in the <code>Device.LocalAgent.MTP.{i}.STOMP.Destination</code> Parameter MUST terminate the STOMP communications session (preferably via the <code>DISCONNECT</code> frame) and enter a connection retry state following <a href="04-index-mtp.html#r-stomp.7" class="requirement">R-STOMP.7</a>.</p>
<p><strong><span id="r-stomp.17">R-STOMP.17 <a href="04-index-mtp.html#r-stomp.17" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints sending a <code>SUBSCRIBE</code> frame MUST use an <code>ack</code> value of “auto”.</p>
<h3 id="sec:mapping-usp-records-to-stomp-frames">4.4.3 Mapping USP Records to STOMP Frames <a href="04-index-mtp.html#sec:mapping-usp-records-to-stomp-frames" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>A USP Record is sent from a USP Endpoint to a STOMP Server within a <code>SEND</code> frame. The STOMP Server delivers that USP Record to the destination STOMP Endpoint within a <code>MESSAGE</code> frame. When a USP Endpoint responds to the USP request, the USP Endpoint sends the USP Record to the STOMP Server within a <code>SEND</code> frame, and the STOMP Server delivers that USP Record to the destination USP Endpoint within a <code>MESSAGE</code> frame.</p>
<p><strong><span id="r-stomp.18">R-STOMP.18 <a href="04-index-mtp.html#r-stomp.18" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing STOMP clients for message transport MUST send USP Records in a <code>SEND</code> frame to the STOMP server as defined in the “SEND” section of the STOMP Specification.</p>
<p><strong><span id="r-stomp.19">R-STOMP.19 <a href="04-index-mtp.html#r-stomp.19" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints sending a <code>SEND</code> frame MUST include (in addition to other mandatory STOMP headers) a <code>content-length</code> STOMP header containing the length of the body included in the <code>SEND</code> frame.</p>
<p><strong><span id="r-stomp.20">R-STOMP.20 <a href="04-index-mtp.html#r-stomp.20" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints sending a <code>SEND</code> frame MUST include (in addition to other mandatory STOMP headers) a <code>content-type</code> STOMP header with a value of “<code>application/vnd.bbf.usp.msg</code>”, which signifies that the body included in the <code>SEND</code> frame contains a Protocol Buffer <span class="cite" data-citation-ids="PROTOBUF"><a href="01-index-introduction.html#ref-PROTOBUF">[6]</a></span> binary encoding message.</p>
<p><strong><span id="r-stomp.21">R-STOMP.21 <a href="04-index-mtp.html#r-stomp.21" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints sending a <code>SEND</code> frame with content-type of <code>application/vnd.bbf.usp.msg</code> MUST include (in addition to other mandatory STOMP headers) a <code>reply-to-dest</code> STOMP header containing the STOMP destination that indicates where the USP Endpoint that receives the USP Record should send any response (if required).</p>
<p><strong><span id="r-stomp.22">R-STOMP.22 <a href="04-index-mtp.html#r-stomp.22" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints sending a <code>SEND</code> frame with content-type of <code>application/vnd.bbf.usp.msg</code> MUST include the Protocol Buffer <span class="cite" data-citation-ids="PROTOBUF"><a href="01-index-introduction.html#ref-PROTOBUF">[6]</a></span> binary encoding of the USP Record as the body of the <code>SEND</code> frame.</p>
<p><strong><span id="r-stomp.23">R-STOMP.23 <a href="04-index-mtp.html#r-stomp.23" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When a USP Endpoint receives a <code>MESSAGE</code> frame it MUST use the <code>reply-to-dest</code> included in the STOMP headers as the STOMP destination of the USP response (if a response is required by the incoming USP request).</p>
<h4 id="sec:handling-errors">4.4.3.1 Handling Errors <a href="04-index-mtp.html#sec:handling-errors" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p>If a STOMP USP Endpoint receives a <code>MESSAGE</code> frame containing a USP Record that cannot be extracted for processing (e.g., text frame instead of a binary frame, malformed USP Record, bad encoding), it will silently drop the unprocessed USP Record. If the requirements according to <a href="04-index-mtp.html#sec:usp-record-errors" class="heading">USP Record Errors</a> are fulfilled, for the STOMP MTP specifically this means that the <code>reply-to-dest</code> information has to be available, then a USP Record with an appropriate Error Message must be created and transmitted via STOMP <code>SEND</code> frame.</p>
<p><em>Note: Error handling was unified between MTPs in USP 1.2 by using USP Records instead of MTP specific messages, deprecating most of this section, specifically the requirements <strong><a href="04-index-mtp.html#r-stomp.23a" class="requirement">R-STOMP.23a</a></strong>, <strong><a href="04-index-mtp.html#r-stomp.23b" class="requirement">R-STOMP.23b</a></strong>, <strong><a href="04-index-mtp.html#r-stomp.24" class="requirement">R-STOMP.24</a></strong>, <strong><a href="04-index-mtp.html#r-stomp.24a" class="requirement">R-STOMP.24a</a></strong> and <strong><a href="04-index-mtp.html#r-stomp.24b" class="requirement">R-STOMP.24b</a></strong>. Please see <a href="04-index-mtp.html#sec:usp-record-errors" class="heading">USP Record Errors</a> for details.</em></p>
<p><strong><span id="r-stomp.23a">R-STOMP.23a <a href="04-index-mtp.html#r-stomp.23a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - USP Endpoints MUST support STOMP content-type header value of <code>application/vnd.bbf.usp.error</code>.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-stomp.23a" class="requirement">R-STOMP.23a</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-stomp.23b">R-STOMP.23b <a href="04-index-mtp.html#r-stomp.23b" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - A USP Endpoint MUST include a <code>usp-err-id</code> STOMP header in <code>SEND</code> frames of content-type <code>application/vnd.bbf.usp.msg</code>. The value of this header is: <code>&lt;USP Record to_id&gt; + "/" + &lt;USP Message msg_id&gt;</code>, the <code>&lt;USP Message msg_id&gt;</code> field can be left blank if the Record does not contain a USP Message. Since the colon “<code>:</code>” is a reserved character in STOMP headers, all instances of “<code>:</code>” in the USP Record to_id MUST be expressed using an encoding of <code>\c</code>.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-stomp.23b" class="requirement">R-STOMP.23b</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-stomp.24">R-STOMP.24 <a href="04-index-mtp.html#r-stomp.24" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - When a USP Endpoint receives a <code>MESSAGE</code> frame containing a USP Record or an encapsulated USP Message within a USP Record that cannot be extracted for processing, the receiving USP Endpoint MUST ignore the USP Record if the received STOMP MESSAGE frame did not include a <code>usp-err-id</code> header.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-stomp.24" class="requirement">R-STOMP.24</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-stomp.24a">R-STOMP.24a <a href="04-index-mtp.html#r-stomp.24a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - When a USP Endpoint receives a MESSAGE frame containing a USP Record or an encapsulated USP Message within a USP Record that cannot be extracted for processing, the receiving USP Endpoint MUST send a STOMP SEND frame with an <code>application/vnd.bbf.usp.error</code> content-type header value if the received STOMP MESSAGE frame included a <code>usp-err-id</code> header.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-stomp.24a" class="requirement">R-STOMP.24a</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-stomp.24b">R-STOMP.24b <a href="04-index-mtp.html#r-stomp.24b" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - A STOMP SEND frame with <code>application/vnd.bbf.usp.error</code> content-type MUST contain the received <code>usp-err-id</code> header, the destination header value set to the received <code>reply-to-dest</code> header, and a message body (formatted using UTF-8 encoding) with the following 2 lines:</p>
<ul>
<li><p><code>err_code:&lt;numeric code indicating the type of error that caused the overall message to fail&gt;</code></p></li>
<li><p><code>err_msg:&lt;additional information about the reason behind the error&gt;</code></p></li>
</ul>
<p>The specific error codes are listed in the MTP <a href="04-index-mtp.html#sec:usp-record-errors" class="heading">USP Record Errors</a> section.</p>
<p>The following is an example message. This example uses “<code>^@</code>” to represent the NULL octet that follows a STOMP body.</p>
<pre><code>SEND
destination:/usp/the-reply-to-dest
content-type:application/vnd.bbf.usp.error
usp-err-id:cid\c3AA3F8\cusp-id-42/683

err_code:7100
err_msg:Field n is not recognized.^@</code></pre>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-stomp.24b" class="requirement">R-STOMP.24b</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-stomp.25">R-STOMP.25 <a href="04-index-mtp.html#r-stomp.25" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If an <code>ERROR</code> frame is received by the USP Endpoint, the STOMP server will terminate the connection. In this case the USP Endpoint MUST enter a connection retry state. For a USP Agent the retry mechanism is based on the <code>STOMP.Connection.{i}.</code> retry Parameters: <code>ServerRetryInitialInterval</code>, <code>ServerRetryIntervalMultiplier</code>, and <code>ServerRetryMaxInterval</code>.</p>
<h4 id="sec:handling-other-stomp-frames">4.4.3.2 Handling Other STOMP Frames <a href="04-index-mtp.html#sec:handling-other-stomp-frames" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p><strong><span id="r-stomp.26">R-STOMP.26 <a href="04-index-mtp.html#r-stomp.26" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing STOMP clients for message transport MUST NOT send the transactional STOMP frames including: <code>BEGIN</code>, <code>COMMIT</code>, and <code>ABORT</code>.</p>
<p><strong><span id="r-stomp.27">R-STOMP.27 <a href="04-index-mtp.html#r-stomp.27" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing STOMP clients for message transport MUST NOT send the acknowledgement STOMP frames including: <code>ACK</code> and <code>NACK</code>.</p>
<p><strong><span id="r-stomp.28">R-STOMP.28 <a href="04-index-mtp.html#r-stomp.28" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing STOMP clients for message transport MAY send the following STOMP frames when shutting down a STOMP connection: <code>UNSUBSCRIBE</code> (according to the rules defined in the UNSUBSCRIBE section of the STOMP Specification) and <code>DISCONNECT</code> (according to the rules defined in the DISCONNECT section of the STOMP Specification).</p>
<p><strong><span id="r-stomp.29">R-STOMP.29 <a href="04-index-mtp.html#r-stomp.29" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing STOMP clients for message transport that DID NOT receive a <code>subscribe-dest</code> STOMP Header in the <code>CONNECTED</code> frame when establishing the STOMP communications session MUST update their STOMP subscription when their destination is altered by sending the <code>UNSUBSCRIBE</code> STOMP frame (according to the rules defined in the UNSUBSCRIBE section of the STOMP Specification) and then re-subscribing as detailed in the “Subscribing a USP Endpoint to a STOMP Destination” section.</p>
<p><strong><span id="r-stomp.30">R-STOMP.30 <a href="04-index-mtp.html#r-stomp.30" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing STOMP clients for message transport MAY receive a <code>RECEIPT</code> frame in which case the STOMP server is acknowledging that the corresponding client frame has been processed by the server.</p>
<h3 id="sec:discovery-requirements">4.4.4 Discovery Requirements <a href="04-index-mtp.html#sec:discovery-requirements" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>The <a href="03-index-discovery.html#sec:discovery" class="heading">USP Discovery</a> section details requirements about the general usage of DNS, mDNS, and DNS-SD records as it pertains to the USP protocol. This section provides further requirements as to how a USP Endpoint advertises discovery information when a STOMP MTP is being utilized.</p>
<p><strong><span id="r-stomp.31">R-STOMP.31 <a href="04-index-mtp.html#r-stomp.31" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When creating a DNS-SD record, an Endpoint MUST set the DNS-SD “<code>path</code>” attribute equal to the value of the destination that it has subscribed to.</p>
<p><strong><span id="r-stomp.32">R-STOMP.32 <a href="04-index-mtp.html#r-stomp.32" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When creating a DNS-SD record, an Endpoint MUST utilize the STOMP server’s address information in the A and AAAA records instead of the USP Endpoint’s address information.</p>
<h3 id="sec:stomp-server-requirements">4.4.5 STOMP Server Requirements <a href="04-index-mtp.html#sec:stomp-server-requirements" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p><strong><span id="r-stomp.33">R-STOMP.33 <a href="04-index-mtp.html#r-stomp.33" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A STOMP server implementation MUST adhere to the requirements defined in the STOMP Specification.</p>
<p><strong><span id="r-stomp.34">R-STOMP.34 <a href="04-index-mtp.html#r-stomp.34" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A STOMP server implementation MUST perform authentication of the STOMP client and ensure that a Remote USP Endpoint is only allowed to subscribe to the destination that is associated with the USP Endpoint.</p>
<p><strong><span id="r-stomp.35">R-STOMP.35 <a href="04-index-mtp.html#r-stomp.35" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - A STOMP server implementation SHOULD support both Client Certification Authentication and Username/Password Authentication mechanisms.</p>
<h3 id="sec:mtp-message-encryption-2">4.4.6 MTP Message Encryption <a href="04-index-mtp.html#sec:mtp-message-encryption-2" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>STOMP MTP message encryption is provided using TLS certificates.</p>
<p><strong><span id="r-stomp.36">R-STOMP.36 <a href="04-index-mtp.html#r-stomp.36" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing STOMP clients for message transport MUST implement TLS 1.2 RFC 5246 <span class="cite" data-citation-ids="RFC5246"><a href="01-index-introduction.html#ref-RFC5246">[17]</a></span> or later with backward compatibility to TLS 1.2.</p>
<p><strong><span id="r-stomp.37">R-STOMP.37 <a href="04-index-mtp.html#r-stomp.37" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - STOMP server certificates MAY contain domain names and those domain names MAY contain domain names with wildcard characters per RFC 6125 <span class="cite" data-citation-ids="RFC6125"><a href="01-index-introduction.html#ref-RFC6125">[21]</a></span> guidance.</p>
<h2 id="sec:mqtt-binding">4.5 MQTT Binding <a href="04-index-mtp.html#sec:mqtt-binding" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h2>
<p>The Message Queuing Telemetry Transport (MQTT) MTP transfers USP Records between USP Endpoints using the MQTT protocol. Messages that are transferred between MQTT clients utilize a message bus interaction model where the MQTT server is the messaging broker that routes and delivers messages based on the Topic Name included in the MQTT Publish packet variable header.</p>
<p>The following figure depicts the transfer of the USP Records between USP Agents and Controllers.</p>
<figure>
<img src="mtp/mqtt/mqtt-architecture.png" id="fig:usp-over-mqtt" alt="Figure 7: USP over MQTT Architecture " /><figcaption aria-hidden="true">Figure 7: USP over MQTT Architecture <a href="04-index-mtp.html#fig:usp-over-mqtt" class="headerlink" title="Permalink to this figure"><img src="permalink.png" style="width:0.8em" /></a></figcaption>
</figure>
<p>The basic steps for any USP Endpoint that utilizes an MQTT MTP are:</p>
<ul>
<li>Negotiate TLS (if required/configured)</li>
<li>Connect to the MQTT Server (server may require Authentication)</li>
<li>Subscribe to a Topic</li>
<li>Publish USP Records</li>
<li>Optionally send <code>PINGREQ</code> messages to keep the connection alive</li>
</ul>
<p>The following figure shows the MQTT packets that have requirements in this section for their use when MQTT is a USP MTP.</p>
<figure>
<img src="mtp/mqtt/mqtt-packets.png" id="fig:mqtt-packets" alt="Figure 8: MQTT Packets " /><figcaption aria-hidden="true">Figure 8: MQTT Packets <a href="04-index-mtp.html#fig:mqtt-packets" class="headerlink" title="Permalink to this figure"><img src="permalink.png" style="width:0.8em" /></a></figcaption>
</figure>
<p><strong><span id="r-mqtt.1">R-MQTT.1 <a href="04-index-mtp.html#r-mqtt.1" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing MQTT clients for message transport MUST implement MQTT 5.0 <span class="cite" data-citation-ids="MQTT-5-0"><a href="01-index-introduction.html#ref-MQTT-5-0">[5]</a></span>.</p>
<p><strong><span id="r-mqtt.2">R-MQTT.2 <a href="04-index-mtp.html#r-mqtt.2" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing MQTT clients for message transport MAY implement MQTT 3.1.1 <span class="cite" data-citation-ids="MQTT-3-1-1"><a href="01-index-introduction.html#ref-MQTT-3-1-1">[4]</a></span>.</p>
<p>Requirements in this MQTT MTP specification are common to both the MQTT 3.1.1 and MQTT 5.0 specifications unless an MQTT version is named.</p>
<p>The MQTT specifications are very complete and comprehensive in describing syntax and usage requirements of MQTT packets and behaviors. Therefore, none of those requirements are re-iterated in this specification. This specification only contains requirements unique to use of MQTT as a USP MTP. The above two requirements for compliance with the MQTT specifications are critical in developing an implementation compliant with this MQTT Binding specification. Wherever an MQTT packet or other functionality is mentioned in the requirements in this MQTT Binding specification, the requirement for compliance with the MQTT specification (<a href="04-index-mtp.html#r-mqtt.1" class="requirement">R-MQTT.1</a> and <a href="04-index-mtp.html#r-mqtt.2" class="requirement">R-MQTT.2</a>) apply.</p>
<p><strong><span id="r-mqtt.3">R-MQTT.3 <a href="04-index-mtp.html#r-mqtt.3" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents utilizing MQTT clients for message transport MUST support MQTT over TCP transport protocol.</p>
<p>The MQTT specification also describes how MQTT can run over WebSockets. Deployments can choose to use MQTT over WebSockets, if they use MQTT clients and servers with support for this option. The TCP option is required to ensure interoperability.</p>
<p><strong><span id="r-mqtt.4">R-MQTT.4 <a href="04-index-mtp.html#r-mqtt.4" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents utilizing MQTT clients for message transport MUST support the <code>MQTTClientCon:1</code>, <code>MQTTClientSubscribe:1</code>, <code>MQTTAgent:1</code>, and <code>MQTTController:1</code> data model profiles.</p>
<p><strong><span id="r-mqtt.5">R-MQTT.5 <a href="04-index-mtp.html#r-mqtt.5" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents utilizing MQTT clients for message transport SHOULD support the <code>MQTTClientExtended:1</code> data model profile.</p>
<h3 id="sec:connecting-a-usp-endpoint-to-the-mqtt-server">4.5.1 Connecting a USP Endpoint to the MQTT Server <a href="04-index-mtp.html#sec:connecting-a-usp-endpoint-to-the-mqtt-server" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>When exchanging USP Records across MQTT MTPs, each USP Endpoint establishes a communications session with an MQTT server. These MQTT communications sessions are expected to be long-lived and are re-used for subsequent exchange of USP Records. An MQTT communications session is established using the procedure in this section. An MQTT communications session is intended to be established as soon as the USP Endpoint becomes network-aware and can send TCP/IP messages.</p>
<p>When an MQTT communications session is no longer necessary or expires (see “Keep Alive” section below), the MQTT connection is closed by the MQTT client, preferably by sending a <code>DISCONNECT</code> packet (see <a href="04-index-mtp.html#sec:handling-other-mqtt-packets" class="heading">Handling Other MQTT Packets</a> section below).</p>
<p><a href="04-index-mtp.html#r-mqtt.1" class="requirement">R-MQTT.1</a> and <a href="04-index-mtp.html#r-mqtt.2" class="requirement">R-MQTT.2</a> require that all MQTT capabilities referenced in this section and its sub-sections are compliant with the MQTT specifications. Reading the MQTT specification is highly recommended to ensure the correct syntax and usage of MQTT packets and properties (<code>CONNECT</code>, <code>CONNACK</code>, User Name, Password, ClientId, User Property, Keep Alive, <code>PINGREQ</code>, <code>PINGRESP</code>, etc.).</p>
<p><strong><span id="r-mqtt.6">R-MQTT.6 <a href="04-index-mtp.html#r-mqtt.6" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing MQTT clients for message transport MUST send a <code>CONNECT</code> packet to the MQTT server to initiate the MQTT communications session.</p>
<p><strong><span id="r-mqtt.7">R-MQTT.7 <a href="04-index-mtp.html#r-mqtt.7" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints with a configured MQTT User Name and Password for use with this MQTT server MUST include these in the MQTT <code>CONNECT</code> packet. The <code>.MQTT.Client.{i}.Username</code> and <code>.MQTT.Client.{i}.Password</code> Parameter values (associated with this MQTT server) will be used for User Name and Password.</p>
<p><strong><span id="r-mqtt.8">R-MQTT.8 <a href="04-index-mtp.html#r-mqtt.8" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints MUST set the value of the <code>CONNECT</code> packet Client Identifier (ClientId) as follows:</p>
<ul>
<li>If a non-empty, non-null ClientId value exists for use with this MQTT server, this MUST be used. The data model Parameter for the ClientId is <code>.MQTT.Client.{i}.ClientID</code>.</li>
<li>If an MQTT 5.0 client has no configured ClientId (null or empty string) the USP Endpoint MUST send an empty string in the Client Identifier property.</li>
<li>If an MQTT 3.1.1 client has no configured ClientId, the USP Endpoint SHOULD attempt to use its USP Endpoint ID as the ClientId.</li>
</ul>
<p><strong><span id="r-mqtt.9">R-MQTT.9 <a href="04-index-mtp.html#r-mqtt.9" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An MQTT 5.0 client MUST save (in the <code>.MQTT.Client.{i}.ClientID</code> Parameter) an Assigned Client Identifier included in a <code>CONNACK</code> packet as its configured ClientId for future connections to the MQTT server.</p>
<p><strong><span id="r-mqtt.10">R-MQTT.10 <a href="04-index-mtp.html#r-mqtt.10" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If the connection to the MQTT server is NOT successful then the USP Endpoint MUST enter a connection retry state. For a USP Agent the retry mechanism is based on the <code>MQTT.Client.{i}.</code> retry Parameters: <code>ConnectRetryTime</code>, <code>ConnectRetryIntervalMultiplier</code>, and <code>ConnectRetryMaxInterval</code>.</p>
<p><strong><span id="r-mqtt.11">R-MQTT.11 <a href="04-index-mtp.html#r-mqtt.11" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - Once a USP Endpoint has successfully connected to an MQTT server, it MUST use the same ClientId for all subsequent connections with that server.</p>
<h4 id="sec:connect-flags-and-properties">4.5.1.1 CONNECT Flags and Properties <a href="04-index-mtp.html#sec:connect-flags-and-properties" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p>The MQTT <code>CONNECT</code> packet has a number of flags and properties that can be set. The User Name and Password flags are set to 1 if these parameters are included. The use of the Will Retain, Will QoS, and Will Flag are left up to the deployment. They are not needed in order to use MQTT as a USP MTP and can be “0” if there is no deployment-specified need for them. The Clean Start flag can also be used according to deployment-specified needs. Configured values for these flags can be provided through the related <code>.MQTT.Client.{i}.</code> Parameters.</p>
<p>MQTT 3.1.1 does not provide a simple mechanism for a USP MQTT client to provide its Endpoint ID to the MQTT server. But the server does have other options, such as:</p>
<ol>
<li>Support Endpoint ID as ClientId.</li>
<li>Get Endpoint ID from client TLS certificate.</li>
</ol>
<p>MQTT 3.1.1 also does not provide a mechanism for the MQTT server to tell a client what Topic other Endpoints should use to send it a message (the “reply to” Topic). This information would need to be pre-configured or provided in some manner not specified here.</p>
<p>MQTT 5.0 includes additional properties that deployments can choose to use.</p>
<p><strong><span id="r-mqtt.12">R-MQTT.12 <a href="04-index-mtp.html#r-mqtt.12" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An MQTT 5.0 USP Endpoint MUST support setting the Request Response Information property to 1, and MUST support receiving the corresponding Response Information in the <code>CONNACK</code> packet.</p>
<p>The Response Information property is used by an MQTT 5.0 client as the Response Topic (which is the MQTT 5.0 <code>PUBLISH</code> packet property identifying the Topic to send a USP response to). The Response Information property requirements for use of the received Response Information are below in <a href="04-index-mtp.html#sec:sending-the-usp-record-in-a-publish-packet-payload" class="heading">Sending the USP Record in a PUBLISH Packet Payload</a>. Ensuring the client is subscribed to this Topic or a Topic Filter that includes this Topic is described in <a href="04-index-mtp.html#sec:subscribing-to-mqtt-topics" class="heading">Subscribing to MQTT Topics</a>.</p>
<p><strong><span id="r-mqtt.13">R-MQTT.13 <a href="04-index-mtp.html#r-mqtt.13" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An MQTT 5.0 USP Endpoint MUST include a User Property name-value pair in the <code>CONNECT</code> packet with name of “usp-endpoint-id” and value of this Endpoint’s USP Endpoint ID.</p>
<h4 id="sec:keep-alive">4.5.1.2 Keep Alive <a href="04-index-mtp.html#sec:keep-alive" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h4>
<p>The MQTT Keep Alive mechanism has several components:</p>
<ul>
<li>The <code>CONNECT</code> packet Keep Alive field tells the server to disconnect the client if the server does not receive a packet from the client before the Keep Alive time (in seconds) has elapsed since the prior received packet.</li>
<li>The MQTT 5.0 <code>CONNACK</code> packet Keep Alive field allows the server to inform the client the maximum interval the server will allow to elapse between received packets before it disconnects the client due to inactivity.</li>
<li><code>PINGREQ</code> and <code>PINGRESP</code> packets can be used to keep the connection up if the timer is nearing expiry and there is no need for another type of message. <code>PINGREQ</code> can also be used by the client at any time to check on the status of the connection.</li>
</ul>
<p>The client can indicate the Server is not required to disconnect the Client on the grounds of inactivity by setting the <code>CONNECT</code> Keep Alive to zero (0). Note that WebSockets mechanisms can be used to keep the connection alive if MQTT is being run over WebSockets. Also note the server is allowed to disconnect the client at any time, regardless of Keep Alive value.</p>
<p><strong><span id="r-mqtt.14">R-MQTT.14 <a href="04-index-mtp.html#r-mqtt.14" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints with a configured Keep Alive value MUST include this in the MQTT <code>CONNECT</code> packet. The <code>.MQTT.Client.{i}.KeepAliveTime</code> Parameter value (associated with this MQTT server) will be used for the Keep Alive value.</p>
<p>Use of <code>PINGREQ</code> and <code>PINGRESP</code> for keeping sessions alive (or determining session aliveness) is as described in the MQTT specification. No additional requirements are provided for use of these packets in a USP context.</p>
<h3 id="sec:subscribing-to-mqtt-topics">4.5.2 Subscribing to MQTT Topics <a href="04-index-mtp.html#sec:subscribing-to-mqtt-topics" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>The <code>SUBSCRIBE</code> packet is sent by the MQTT client to subscribe to one or more Topics or Topic Filters. These are needed to allow the MQTT client to receive application messages. The MQTT client will receive all application messages published by other clients that are sent to a Topic that matches (either exactly or within a wildcarded Topic Filter) a subscribed-to Topic or Topic Filter. The MQTT server indicates in the <code>SUBACK</code> response packet whether the client has succeeded or failed to subscribe to each Topic or Topic Filter sent in the <code>SUBSCRIBE</code> packet.</p>
<p>USP Endpoints can be configured with one or more specific MQTT Topics or Topic Filters to subscribe to for each MQTT server they are associated with. In MQTT 5.0, a <code>CONNACK</code> User Property named “subscribe-topic” can be used to provide the client with Topic or Topic Filter values for the client to subscribe to. There is no similar capability in MQTT 3.1.1. This means configuration or some out-of-band mechanism are the only means of supplying subscription Topics or Topic Filters to an MQTT 3.1.1 client. An Agent will need to be configured with a Controller’s MQTT Topic (the <code>Device.LocalAgent.Controller.{i}.MTP.{i}.MQTT.Topic</code> Parameter is used to configure this), to send a Notification to that Controller.</p>
<p><span id="r-mqtt.1-1">R-MQTT.1 <a href="04-index-mtp.html#r-mqtt.1-1" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span> and <a href="04-index-mtp.html#r-mqtt.2" class="requirement">R-MQTT.2</a> require that all MQTT capabilities referenced in this section and its sub-sections are compliant with the MQTT specifications. Reading the MQTT specification is highly recommended to ensure the correct syntax and usage of MQTT packets and properties (<code>SUBSCRIBE</code>, Topic Filter, QoS 0, QoS 1, QoS 2, etc.).</p>
<p><strong><span id="r-mqtt.15">R-MQTT.15 <a href="04-index-mtp.html#r-mqtt.15" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints that successfully connect to an MQTT server MUST send a <code>SUBSCRIBE</code> packet with all Topic Filters identified in the following list:</p>
<ul>
<li>All configured Topic Filter values for use with this MQTT server MUST be included in a <code>SUBSCRIBE</code> packet. For a USP Agent, the <code>.MQTT.Client.{i}.Subscription.{i}.</code> table can be used to configure Topic Filter values.</li>
<li>If an MQTT 5.0 USP Endpoint received one or more User Property in the <code>CONNACK</code> packet where the name of the name-value pair is “subscribe-topic”, the USP Endpoint MUST include the value of all such name-value pairs in its <code>SUBSCRIBE</code> packet as a Topic Filter.</li>
<li>If an MQTT 5.0 Endpoint received a Response Information property in the <code>CONNACK</code> packet, and the topic from that Response Information property is not included (directly or as a subset of a Topic Filter) among the Topic Filters of the previous 2 bullets, the Endpoint MUST include the value of the Response Information property in its <code>SUBSCRIBE</code> packet.</li>
<li>If an Endpoint has a <code>ResponseTopicConfigured</code> value and did not receive a Response Information property in the <code>CONNACK</code> packet, and the topic in the <code>ResponseTopicConfigured</code> Parameter is not included (directly or as a subset of a Topic Filter) among the Topic Filters of the first 2 bullets, the Endpoint MUST include the value of the <code>ResponseTopicConfigured</code> in its <code>SUBSCRIBE</code> packet.</li>
</ul>
<p><strong><span id="r-mqtt.16">R-MQTT.16 <a href="04-index-mtp.html#r-mqtt.16" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Agents that have NOT received a “subscribe-topic” User Property in the <code>CONNACK</code> and do NOT have a configured Topic Filter (<code>Device.MQTT.Client.{i}.Subscription.{i}.Topic</code> Parameter for this Client instance in the data model) MUST terminate the MQTT communications session (via the <code>DISCONNECT</code> packet) and consider the MTP disabled.</p>
<p><strong><span id="r-mqtt.17">R-MQTT.17 <a href="04-index-mtp.html#r-mqtt.17" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If a USP Endpoint does not successfully subscribe to at least one Topic, it MUST NOT publish a packet with a USP Record in its Application Message, and MUST disconnect from the MQTT server.</p>
<p>For each Topic listed in a <code>SUBSCRIBE</code> packet, the client will also provide a desired QoS level. See the MQTT specification (MQTT 3.1.1 <span class="cite" data-citation-ids="MQTT-3-1-1"><a href="01-index-introduction.html#ref-MQTT-3-1-1">[4]</a></span> or MQTT 5.0 <span class="cite" data-citation-ids="MQTT-5-0"><a href="01-index-introduction.html#ref-MQTT-5-0">[5]</a></span>, Section 4.3) for description of the three QoS levels (QoS 0, QoS 1, QoS 2). The usefulness of these QoS levels in the context of USP depends on the particulars of the MQTT deployment. It is therefore up to the implementer / deployer to decide which QoS setting to use. In order to ensure deployments have the ability to use at least QoS 1, MQTT clients and servers are required to implement at least QoS 1 (see requirements in <a href="04-index-mtp.html#sec:sending-the-usp-record-in-a-publish-packet-payload" class="heading">Sending the USP Record in a PUBLISH Packet Payload</a> and <a href="04-index-mtp.html#sec:mqtt-server-requirements" class="heading">MQTT Server Requirements</a>).</p>
<h3 id="sec:sending-the-usp-record-in-a-publish-packet-payload">4.5.3 Sending the USP Record in a PUBLISH Packet Payload <a href="04-index-mtp.html#sec:sending-the-usp-record-in-a-publish-packet-payload" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>A USP Record is sent from a USP Endpoint to an MQTT Server within a <code>PUBLISH</code> packet payload. The MQTT Server delivers that <code>PUBLISH</code> packet to the destination MQTT client USP Endpoint. This is true of all USP Message types.</p>
<p><span id="r-mqtt.1-2">R-MQTT.1 <a href="04-index-mtp.html#r-mqtt.1-2" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span> and <a href="04-index-mtp.html#r-mqtt.2" class="requirement">R-MQTT.2</a> require that all MQTT capabilities referenced in this section and its sub-sections are compliant with the MQTT specifications. Reading the MQTT specification is highly recommended to ensure the correct syntax and usage of MQTT packets and properties (<code>PUBLISH</code>, Content Type, Response Topic, etc.).</p>
<p><strong><span id="r-mqtt.18">R-MQTT.18 <a href="04-index-mtp.html#r-mqtt.18" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing MQTT clients for message transport MUST send the USP Record in the payload of a <code>PUBLISH</code> packet.</p>
<p><strong><span id="r-mqtt.19">R-MQTT.19 <a href="04-index-mtp.html#r-mqtt.19" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints MUST send USP Records using the Protocol Buffer <span class="cite" data-citation-ids="PROTOBUF"><a href="01-index-introduction.html#ref-PROTOBUF">[6]</a></span> binary encoding of the USP Record.</p>
<p><strong><span id="r-mqtt.20">R-MQTT.20 <a href="04-index-mtp.html#r-mqtt.20" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing MQTT clients for message transport MUST support MQTT QoS 0 and QoS 1.</p>
<p>The USP Controller’s MQTT Topic needs to be known by any USP Agent expected to send a Notify message to the Controller.</p>
<p>The USP Agent will also need to know an exact Topic where it can be reached (and not just a Topic Filter) in order to provide a Controller with the Agent’s “reply to” Topic.</p>
<p><strong><span id="r-mqtt.21">R-MQTT.21 <a href="04-index-mtp.html#r-mqtt.21" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An MQTT 5.0 USP Endpoint that receives Response Information in the <code>CONNACK</code> packet MUST use this as its “reply to” Topic.</p>
<p><strong><span id="r-mqtt.22">R-MQTT.22 <a href="04-index-mtp.html#r-mqtt.22" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints MUST include a “reply to” Topic in all <code>PUBLISH</code> packets transporting USP Records.</p>
<p><strong><span id="r-mqtt.23">R-MQTT.23 <a href="04-index-mtp.html#r-mqtt.23" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints using MQTT 5.0 MUST include their “reply to” Topic in the <code>PUBLISH</code> Response Topic property.</p>
<p><strong><span id="r-mqtt.24">R-MQTT.24 <a href="04-index-mtp.html#r-mqtt.24" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints using MQTT 3.1.1 MUST include their “reply to” Topic after “/reply-to=” at the end of the <code>PUBLISH</code> Topic Name, with any “/” character in the Topic replaced by “%2F”.</p>
<p>For example, if a Controller’s “reply to” Topic is “usp/controllers/oui:00256D:my-unique-bbf-id-42”, and it is sending to an Agent whose Topic is “usp/agents/cid:3AA3F8:my-unique-usp-id-42”, the <code>PUBLISH</code> Topic Name for a USP Controller using an MQTT 3.1.1 client will be “usp/agents/cid:3AA3F8:my-unique-usp-id-42/reply-to= usp%2Fcontrollers%2Foui:00256D:my-unique-bbf-id-42”.</p>
<p>USP Endpoints that need to send a response to a received USP Record will need to determine the Topic Name to use in the responding <code>PUBLISH</code> packet.</p>
<p><strong><span id="r-mqtt.25">R-MQTT.25 <a href="04-index-mtp.html#r-mqtt.25" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints using MQTT 3.1.1 MUST interpret the portion of the received <code>PUBLISH</code> Topic Name following the last forward slash “/reply-to=” as the response Topic Name. Any instance of “%2F” in this received string MUST be replaced with “/”.</p>
<p><strong><span id="r-mqtt.26">R-MQTT.26 <a href="04-index-mtp.html#r-mqtt.26" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints using MQTT 5.0 MUST use the received <code>PUBLISH</code> Response Topic property as the response Topic Name.</p>
<p>When an USP Endpoint receives a MQTT 3.1.1 <code>PUBLISH</code> packet without “reply to” Topic or a USP <code>Connect</code> Record with a different MQTT version indicated in the <code>version</code> field of the <code>mqtt_connect</code> Record type, then a MQTT version mismatch between brokers involved in the MQTT communication has occurred.</p>
<p><strong><span id="r-mqtt.26a">R-MQTT.26a <a href="04-index-mtp.html#r-mqtt.26a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If a MQTT version mismatch is encountered and the sender “reply to” Topic is known, the receiving Endpoint MUST handle this error according to <a href="04-index-mtp.html#sec:mqtt-handling-errors" class="heading">Handling Errors</a> and cease communication until the mismatch has been addressed by the sender.</p>
<p><strong><span id="r-mqtt.27">R-MQTT.27 <a href="04-index-mtp.html#r-mqtt.27" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints sending a USP Record using MQTT 5.0 MUST have “usp.msg” in the Content Type property.</p>
<p>MQTT clients using MQTT 3.1.1 will need to know to pass the payload to the USP Agent for handling. There is no indication in MQTT 3.1.1 of the payload application or encoding. an MQTT 3.1.1 deployment could choose to dedicate the MQTT connection to USP, or put something in the syntax of <code>PUBLISH</code> packet Topic Names that would indicate the payload is a USP Record.</p>
<p><strong><span id="r-mqtt.27a">R-MQTT.27a <a href="04-index-mtp.html#r-mqtt.27a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints receiving a MQTT 5.0 <code>PUBLISH</code> packet MUST interpret the Content Type property of “usp.msg” or “application/vnd.bbf.usp.msg” (the registered USP Record MIME type) as indicating the packet contains a USP Record.</p>
<h3 id="sec:mqtt-handling-errors">4.5.4 Handling Errors <a href="04-index-mtp.html#sec:mqtt-handling-errors" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>The MQTT specification requires servers and clients to disconnect if there is a violation at the MQTT protocol layer.</p>
<p>If a MQTT USP Endpoint receives a <code>PUBLISH</code> packet containing a USP Record that cannot be extracted for processing (e.g. malformed USP Record or bad encoding), it will silently drop the unprocessed USP Record. If the requirements according to <a href="04-index-mtp.html#sec:usp-record-errors" class="heading">USP Record Errors</a> are fulfilled, then a USP Record with an appropriate Error Message will be created and published.</p>
<p><em>Note: Error handling was unified between MTPs in USP 1.2 by using USP Records instead of MTP specific messages, deprecating most of this section, specifically <strong><a href="04-index-mtp.html#r-mqtt.28" class="requirement">R-MQTT.28</a></strong>, <strong><a href="04-index-mtp.html#r-mqtt.29" class="requirement">R-MQTT.29</a></strong>, <strong><a href="04-index-mtp.html#r-mqtt.30" class="requirement">R-MQTT.30</a></strong>, <strong><a href="04-index-mtp.html#r-mqtt.31" class="requirement">R-MQTT.31</a></strong>, <strong><a href="04-index-mtp.html#r-mqtt.31a" class="requirement">R-MQTT.31a</a></strong> and <strong><a href="04-index-mtp.html#r-mqtt.32" class="requirement">R-MQTT.32</a></strong>. Please see <a href="04-index-mtp.html#sec:usp-record-errors" class="heading">USP Record Errors</a> for details.</em></p>
<p><strong><span id="r-mqtt.28">R-MQTT.28 <a href="04-index-mtp.html#r-mqtt.28" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - MQTT 5.0 Endpoints MUST support <code>PUBLISH</code> Content Type value of “usp.error”.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-mqtt.28" class="requirement">R-MQTT.28</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-mqtt.29">R-MQTT.29 <a href="04-index-mtp.html#r-mqtt.29" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - MQTT 5.0 Endpoints MUST include a <code>usp-err-id</code> MQTT User Property in <code>PUBLISH</code> packets of content-type “usp.msg”. The value of this User Property is: <code>&lt;USP Record to_id&gt; + "/" + &lt;USP Message msg_id&gt;</code>, the <code>&lt;USP Message msg_id&gt;</code> field can be left blank if the Record does not contain a USP Message.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-mqtt.29" class="requirement">R-MQTT.29</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-mqtt.30">R-MQTT.30 <a href="04-index-mtp.html#r-mqtt.30" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - When an MQTT 3.1.1 USP Endpoint receives a <code>PUBLISH</code> packet containing a USP Record or an encapsulated USP Message within a USP Record that cannot be extracted for processing, the receiving USP Endpoint MUST silently drop the USP Record.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-mqtt.30" class="requirement">R-MQTT.30</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-mqtt.31">R-MQTT.31 <a href="04-index-mtp.html#r-mqtt.31" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - When an MQTT 5.0 USP Endpoint receives a <code>PUBLISH</code> packet containing a USP Record or an encapsulated USP Message within a USP Record that cannot be extracted for processing and the <code>PUBLISH</code> packet contains a <code>usp-err-id</code> header, the receiving USP Endpoint MUST send a <code>PUBLISH</code> packet with Content Type “usp.error”, a User Property set to the received <code>usp-err-id</code> User Property, the Topic Name set to the received Response Topic, and a <code>PUBLISH</code> Payload (formatted using UTF-8 encoding) with the following 2 lines:</p>
<ul>
<li><code>err_code:</code>&lt;numeric code indicating the type of error that caused the overall message to fail&gt;</li>
<li><code>err_msg:</code>&lt;additional information about the reason behind the error&gt;</li>
</ul>
<p>The specific error codes are listed in the MTP <a href="04-index-mtp.html#sec:usp-record-errors" class="heading">USP Record Errors</a> section.</p>
<p>MQTT 5.0 includes a Reason Code that is used to respond to <code>PUBLISH</code> packets when QoS 1 or QoS 2 is used.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-mqtt.31" class="requirement">R-MQTT.31</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-mqtt.31a">R-MQTT.31a <a href="04-index-mtp.html#r-mqtt.31a" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - USP Endpoints receiving a MQTT 5.0 <code>PUBLISH</code> packet MUST interpret the Content Type property of “usp.error” or “application/vnd.bbf.usp.error” (the registered USP error message MIME type) as indicating the packet contains a USP error message and code.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-mqtt.31a" class="requirement">R-MQTT.31a</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-mqtt.32">R-MQTT.32 <a href="04-index-mtp.html#r-mqtt.32" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> (DEPRECATED) - When a USP Endpoint using MQTT 5.0 receives a <code>PUBLISH</code> packet with QoS 1 or QoS 2 containing a USP Record or an encapsulated USP Message within a USP Record that cannot be extracted for processing, the receiving USP Endpoint MUST include Reason Code 153 (0x99) identifying “Payload format invalid” in any <code>PUBACK</code> or <code>PUBREC</code> packet.</p>
<p>Note these packets will be received by the MQTT server and will not be forwarded to the USP Endpoint that originally sent the USP Record.</p>
<p><em>Note: Requirement <a href="04-index-mtp.html#r-mqtt.32" class="requirement">R-MQTT.32</a> was removed in USP 1.2</em></p>
<p><strong><span id="r-mqtt.33">R-MQTT.33 <a href="04-index-mtp.html#r-mqtt.33" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If the MQTT server terminates the connection, the USP Endpoint MUST enter a connection retry state. For a USP Agent the retry mechanism is based on the MQTT.Client.{i}. <code>ConnectRetryTime</code> Parameter.</p>
<h3 id="sec:handling-other-mqtt-packets">4.5.5 Handling Other MQTT Packets <a href="04-index-mtp.html#sec:handling-other-mqtt-packets" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>Use of <code>PUBREL</code>, and <code>PUBCOMP</code> depends on the QoS level being used for the subscribed Topic. No additional requirements are provided for use of these packets in a USP context.</p>
<p>Use of <code>PINGREQ</code> and <code>PINGRESP</code> for keeping sessions alive (or determining session aliveness) is as described in the MQTT specification. No additional requirements are provided for use of these packets in a USP context.</p>
<p>Use of <code>UNSUBSCRIBE</code> and <code>UNSUBACK</code> is as described in the MQTT specification. If an Agent’s configured Topics are disabled by a Controller (by setting Device.MQTT.Client.{i}.Subscription.{i}.Enable to “false”), <code>UNSUBSCRIBE</code> is used to unsubscribe from them.</p>
<p><strong><span id="r-mqtt.34">R-MQTT.34 <a href="04-index-mtp.html#r-mqtt.34" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing MQTT clients for message transport SHOULD send an <code>UNSUBSCRIBE</code> packet when a subscribed Topic or Topic Filter is no longer indicated but the MQTT connection is expected to stay up.</p>
<p><span id="r-mqtt.1-3">R-MQTT.1 <a href="04-index-mtp.html#r-mqtt.1-3" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span> and <a href="04-index-mtp.html#r-mqtt.2" class="requirement">R-MQTT.2</a> require that all MQTT capabilities referenced in this section and its sub-sections are compliant with the MQTT specifications. Reading the MQTT specification is highly recommended to ensure the correct syntax and usage of MQTT packets and properties (<code>DISCONNECT</code>, etc.).</p>
<p><strong><span id="r-mqtt.35">R-MQTT.35 <a href="04-index-mtp.html#r-mqtt.35" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing MQTT clients for message transport SHOULD send a <code>DISCONNECT</code> packet when shutting down an MQTT connection.</p>
<p>MQTT 5.0 specifies the <code>AUTH</code> packet to use for extended authentication. Implementations can make use of extended authentication but should only do so if they are sure that all clients and servers will support the same authentication mechanisms.</p>
<h3 id="sec:discovery-requirements-1">4.5.6 Discovery Requirements <a href="04-index-mtp.html#sec:discovery-requirements-1" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>The USP discovery section details requirements about the general usage of DNS, mDNS, and DNS-SD records as it pertains to the USP protocol. This section provides further requirements as to how a USP Endpoint advertises discovery information when an MQTT MTP is being utilized.</p>
<p><strong><span id="r-mqtt.36">R-MQTT.36 <a href="04-index-mtp.html#r-mqtt.36" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When creating a DNS-SD record (<a href="03-index-discovery.html#sec:dns-sd-records" class="heading">DNS-SD Records</a>), an Agent MUST set the DNS-SD “path” attribute equal to the value of its “reply to” Topic.</p>
<p><strong><span id="r-mqtt.37">R-MQTT.37 <a href="04-index-mtp.html#r-mqtt.37" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When creating a DNS-SD record (<a href="03-index-discovery.html#sec:dns-sd-records" class="heading">DNS-SD Records</a>), a Controller MUST set the DNS-SD “path” attribute equal to a value that is included among the Controller’s subscribed Topics and Topic Filters.</p>
<p><strong><span id="r-mqtt.38">R-MQTT.38 <a href="04-index-mtp.html#r-mqtt.38" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - When creating a DNS-SD record, an Endpoint MUST utilize the MQTT server’s address information in the A and AAAA records instead of the USP Endpoint’s address information.</p>
<h3 id="sec:mqtt-server-requirements">4.5.7 MQTT Server Requirements <a href="04-index-mtp.html#sec:mqtt-server-requirements" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p><strong><span id="r-mqtt.39">R-MQTT.39 <a href="04-index-mtp.html#r-mqtt.39" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - MQTT servers MUST implement MQTT 5.0 <span class="cite" data-citation-ids="MQTT-5-0"><a href="01-index-introduction.html#ref-MQTT-5-0">[5]</a></span>.</p>
<p><strong><span id="r-mqtt.40">R-MQTT.40 <a href="04-index-mtp.html#r-mqtt.40" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - MQTT servers SHOULD implement MQTT 3.1.1 <span class="cite" data-citation-ids="MQTT-3-1-1"><a href="01-index-introduction.html#ref-MQTT-3-1-1">[4]</a></span>.</p>
<p><strong><span id="r-mqtt.41">R-MQTT.41 <a href="04-index-mtp.html#r-mqtt.41" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - MQTT servers MUST implement MQTT over TCP transport protocol.</p>
<p><strong><span id="r-mqtt.42">R-MQTT.42 <a href="04-index-mtp.html#r-mqtt.42" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An MQTT server MUST support authentication of the MQTT client through at least one of the mechanisms described in Section 5.4.1 of the MQTT specification, and support an Access Control List mechanism that can restrict the topics an authenticated MQTT client can subscribe or publish to.</p>
<p><strong><span id="r-mqtt.43">R-MQTT.43 <a href="04-index-mtp.html#r-mqtt.43" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An MQTT server SHOULD support both Client Certification Authentication and User Name / Password Authentication mechanisms.</p>
<p><strong><span id="r-mqtt.44">R-MQTT.44 <a href="04-index-mtp.html#r-mqtt.44" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An MQTT server SHOULD support sending Topic or Topic Filter values in a “subscribe-topic” User Property in the <code>CONNACK</code> packet.</p>
<p><strong><span id="r-mqtt.45">R-MQTT.45 <a href="04-index-mtp.html#r-mqtt.45" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - If an MQTT server supports subscriptions from unconfigured Agents, it MUST support wildcarded Topic Filters.</p>
<p>This will allow support for Agents that try to subscribe to “+/&lt;Endpoint ID&gt;/#” and “+/+/&lt;Endpoint ID&gt;/#” Topic Filters.</p>
<p><strong><span id="r-mqtt.46">R-MQTT.46 <a href="04-index-mtp.html#r-mqtt.46" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An MQTT server MUST support at least MQTT QoS 1 level.</p>
<p><strong><span id="r-mqtt.47">R-MQTT.47 <a href="04-index-mtp.html#r-mqtt.47" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - An MQTT server SHOULD support a ClientId value that is a USP Endpoint ID. This includes supporting all Endpoint ID characters (includes “-”, “.”, “_”, “%”, and “:”) and at least 64 characters length.</p>
<h3 id="sec:mtp-message-encryption-3">4.5.8 MTP Message Encryption <a href="04-index-mtp.html#sec:mtp-message-encryption-3" class="headerlink" title="Permalink to this header"><img src="permalink.png" style="width:0.8em" /></a></h3>
<p>MQTT MTP message encryption is provided using TLS certificates.</p>
<p><strong><span id="r-mqtt.48">R-MQTT.48 <a href="04-index-mtp.html#r-mqtt.48" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - USP Endpoints utilizing MQTT clients for message transport MUST implement TLS 1.2 <span class="cite" data-citation-ids="RFC5246"><a href="01-index-introduction.html#ref-RFC5246">[17]</a></span> or later with backward compatibility to TLS 1.2.</p>
<p><strong><span id="r-mqtt.49">R-MQTT.49 <a href="04-index-mtp.html#r-mqtt.49" class="headerlink" title="Permalink to this span"><img src="permalink.png" style="width:0.8em" /></a></span></strong> - MQTT server certificates MAY contain domain names and those domain names MAY contain domain names with wildcard characters per RFC 6125 <span class="cite" data-citation-ids="RFC6125"><a href="01-index-introduction.html#ref-RFC6125">[21]</a></span> guidance.</p>
    <div style="clear: both;"/>
    <footer class="site-footer">
<nav>
<p>
   <a href="00-index-contents.html#contents">Cover Page</a>
 | <a href="01-index-introduction.html#sec:introduction">1 Introduction</a>
 | <a href="02-index-architecture.html#sec:architecture">2 Architecture</a>
 | <a href="03-index-discovery.html#sec:discovery">3 Discovery and Advertisement</a>
 | <a href="04-index-mtp.html#sec:mtp">4 Message Transfer Protocols</a>
 | <a href="05-index-encoding.html#sec:encoding">5 Message Encoding</a>
 | <a href="06-index-e2e-message-exchange.html#sec:e2e-message-exchange">6 End to End Message Exchange</a>
 | <a href="07-index-messages.html#sec:messages">7 Messages</a>
 | <a href="08-index-auth.html#sec:auth">8 Authentication and Authorization</a>
 | <a href="09-index-bulk-data-collection.html#sec:bulk-data-collection">Annex A: Bulk Data Collection</a>
 | <a href="10-index-software-module-management.html#sec:software-module-management">Appendix I: Software Module Management</a>
 | <a href="11-index-firmware-management-of-devices-with-usp-agents.html#sec:firmware-management-of-devices-with-usp-agents">Appendix II: Firmware Management of Devices with USP Agents</a>
 | <a href="12-index-device-proxy.html#sec:device-proxy">Appendix III: Device Proxy</a>
 | <a href="13-index-proxying.html#sec:proxying">Appendix IV: Proxying</a>
 | <a href="14-index-iot-data-model-theory-of-operation.html#sec:iot-data-model-theory-of-operation">Appendix V: IoT Data Model Theory of Operation</a>
 | <a href="99-index-footnotes.html#footnotes">Footnotes</a>
</p>
</nav>

      <span class="site-footer-owner">
        USP is developed and maintained
        by <a href="https://www.broadband-forum.org">The Broadband Forum</a>.
        &copy; The Broadband Forum 2022</a>. All Rights Reserved.
      </span>
      <span class="site-footer-credits">
        This page was generated by <a href="https://pandoc.org">pandoc</a>
        and <a href="https://pages.github.com">GitHub Pages</a>.
        View the <a href="https://github.com/BroadbandForum/usp">specification source on GitHub</a>.
        <span class="release"/>
      </span>
    </footer>
  </section>
</body>
</html>
